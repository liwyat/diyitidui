<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>优先级数据处理系统【本地处理工具，无任何上传云端数据】</title>
    <!-- 引入Tailwind CSS - 使用优化版本避免生产环境警告 -->
    <script>
        tailwind.config = {
            disableTelemetry: true,
            corePlugins: {
                preflight: false,
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto { content-visibility: auto; }
        }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        };
    </script>
    <script>
        // 客服账号和小组对照表
        const staffGroupMap = {
	'sz-123112-extchengqi': '唐闫一组',
'sz-153771-wushaogang': '唐闫一组',
'sz-156723-liwenyue': '唐闫一组',
'sz-155909-caizemin': '唐闫一组',
'sz-156617-wangling': '唐闫一组',
'sz-157168-wangwubin': '唐闫一组',
'sz-155955-sumeiyuan': '唐闫一组',
'sz-156969-zhouhaixua': '唐闫一组',
'sz-153770-liulian': '唐闫一组',
'sz-164439-yangyue': '唐闫一组',
'sz-164442-mazhencong': '唐闫一组',
'sz-164475-liuzilin': '唐闫一组',
'sz-169858-hejinhua': '唐闫一组',
'sz-171010-qihaiyan': '唐闫一组',
'sz-175921-wanting': '唐闫一组',
'sz-175939-songshuang': '唐闫一组',
'sz-120752-xupeiyun1': '唐闫一组',
'sz-126700-geyanjie3': '唐闫一组',
'sz-128373-xieyu': '唐闫一组',
'sz-128931-tianhongsu': '唐闫一组',
'sz-129078-wangdoudou': '唐闫一组',
'sz-131694-buxiangyan': '唐闫一组',
'sz-131702-shiyuanyua': '唐闫一组',
'sz-132333-liyue': '唐闫一组',
'sz-132365-surong': '唐闫一组',
'sz-132379-xiaojianqi': '唐闫一组',
'sz-132496-yangting': '唐闫一组',
'sz-132547-lvjiake': '唐闫一组',
'sz-132550-zhangaqiqi': '唐闫一组',
'sz-132566-zhuling': '唐闫一组',
'sz-132706-zhongjun': '唐闫一组',
'sz-132709-wuqiong': '唐闫一组',
'sz-132722-liyamei': '唐闫一组',
'sz-132838-chenlei': '唐闫一组',
'sz-132867-laisaixing': '唐闫一组',
'sz-132880-shangjuan': '唐闫一组',
'sz-132903-liaohuan': '唐闫一组',
'sz-132956-wangjuan': '唐闫一组',
'sz-133308-wujiaojiao': '唐闫一组',
'sz-133393-suhuaiyan': '唐闫一组',
'sz-133525-linchungui': '唐闫一组',
'sz-133582-zhaokunmin': '唐闫一组',
'sz-133747-xiaxiaofen': '唐闫一组',
'sz-133789-yxcaiwenka': '唐闫一组',
'sz-133912-jiangruihu': '唐闫一组',
'sz-133916-wangtingti': '唐闫一组',
'sz-134042-songli': '唐闫一组',
'sz-134162-niuhongxia': '唐闫一组',
'sz-134283-dingwei': '唐闫一组',
'sz-134422-dongjinfen': '唐闫一组',
'sz-134567-zhangyaqia': '唐闫一组',
'sz-134767-yangxuli': '唐闫一组',
'sz-134848-yangmin': '唐闫一组',
'sz-134863-gaoguiyang': '唐闫一组',
'sz-134920-suhong': '唐闫一组',
'sz-135078-xiedawei': '唐闫一组',
'sz-135081-duanguoqia': '唐闫一组',
'sz-135273-weifenfen': '唐闫一组',
'sz-135460-wuzhi': '唐闫一组',
'sz-125671-xiajinghua': '唐闫一组',
'sz-127303-denghuidan': '唐闫一组',
'sz-155056-xuchongzhi': '唐闫一组',
'sz-154931-tangshangx': '唐闫一组',
'sz-155020-dengyumei': '唐闫一组',
'sz-155046-huyueming': '唐闫一组',
'sz-155570-lijiaojiao': '唐闫一组',
'sz-155634-yangsimin': '唐闫一组',
'sz-155673-chengli': '唐闫一组',
'sz-155808-yangzixia': '唐闫一组',
'sz-155933-pangxuedon': '唐闫一组',
'sz-156067-liubirong': '唐闫一组',
'sz-156068-liujiangya': '唐闫一组',
'sz-156135-yujing': '唐闫一组',
'sz-156192-liqia': '唐闫一组',
'sz-156278-zhanglihon': '唐闫一组',
'sz-156305-chenjuan': '唐闫一组',
'sz-156393-wangju': '唐闫一组',
'sz-156424-xiaobenqio': '唐闫一组',
'sz-156456-chengqianq': '唐闫一组',
'sz-156650-kuangmeiya': '唐闫一组',
'sz-156885-xinying': '唐闫一组',
'sz-156913-zhengqinqi': '唐闫一组',
'sz-156995-liuhuijie': '唐闫一组',
'sz-157042-wushuang27': '唐闫一组',
'sz-157139-liujing': '唐闫一组',
'sz-157339-wangjing': '唐闫一组',
'sz-157798-zhengsiwei': '唐闫一组',
'sz-157897-xuebai': '唐闫一组',
'sz-158085-caozhiqi1': '唐闫一组',
'sz-158088-changtieyi': '唐闫一组',
'sz-158367-changpings': '唐闫一组',
'sz-158405-huangyumei': '唐闫一组',
'sz-158531-chensiyan': '唐闫一组',
'sz-158560-huangyanme': '唐闫一组',
'sz-158616-qinxiaohui': '唐闫一组',
'sz-159054-xujing': '唐闫一组',
'sz-159075-lilijuan': '唐闫一组',
'sz-159101-shuli13': '唐闫一组',
'sz-159117-xuezhenzhe': '唐闫一组',
'sz-159130-yuxiaoxiao': '唐闫一组',
'sz-159173-heyangqing': '唐闫一组',
'sz-159209-cabling': '唐闫一组',
'sz-159244-yelinli': '唐闫一组',
'sz-159496-tianli55': '唐闫一组',
'sz-118764-extzhangbo': '唐闫二组（王静）',
'sz-124786-extqinlili': '唐闫二组（王静）',
'sz-122600-liangchunl': '唐闫二组（王静）',
'sz-153727-liying': '唐闫二组（王静）',
'sz-154410-suntian': '唐闫二组（王静）',
'sz-156321-limiao': '唐闫二组（王静）',
'sz-157132-liyan': '唐闫二组（王静）',
'sz-155169-yangshunli': '唐闫二组（王静）',
'sz-152842-liangjianr': '唐闫二组（王静）',
'sz-156323-lidanfeng': '唐闫二组（王静）',
'sz-156162-wangqianqi': '唐闫二组（王静）',
'sz-156315-lijie': '唐闫二组（王静）',
'sz-152836-lincaiyu': '唐闫二组（王静）',
'sz-156194-liumeirong': '唐闫二组（王静）',
'sz-155473-yanfengqio': '唐闫二组（王静）',
'sz-154135-jiangyu': '唐闫二组（王静）',
'sz-156966-jiaqianmin': '唐闫二组（王静）',
'sz-154702-liying': '唐闫二组（王静）',
'sz-155345-wangyuanyu': '唐闫二组（王静）',
'sz-153792-marongwen': '唐闫二组（王静）',
'sz-155335-liuwenna': '唐闫二组（王静）',
'sz-152876-hujingxian': '唐闫二组（王静）',
'sz-155051-zhangxinyo': '唐闫二组（王静）',
'sz-156045-wuyang': '唐闫二组（王静）',
'sz-155416-zhangdan': '唐闫二组（王静）',
'sz-153622-xuxue': '唐闫二组（王静）',
'sz-163805-houfangyu': '唐闫二组（王静）',
'sz-164149-zhouyexi': '唐闫二组（王静）',
'sz-164251-zhangjian': '唐闫二组（王静）',
'sz-166233-quqiaomei': '唐闫二组（王静）',
'sz-166417-liangxiaox': '唐闫二组（王静）',
'sz-167095-chenxiaoxi': '唐闫二组（王静）',
'sz-168454-pandidi': '唐闫二组（王静）',

        };
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-height {
                transition: max-height 0.3s ease;
            }
            .table-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .highlight-cell {
                @apply bg-danger/10 border-l-4 border-danger font-medium;
            }
            .first-tier {
                @apply bg-secondary/10 border-l-4 border-secondary;
            }
            .second-tier {
                @apply bg-warning/10 border-l-4 border-warning;
            }
            .third-tier {
                @apply bg-danger/10 border-l-4 border-danger;
            }
            .pagination-btn {
                @apply px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 transition-colors;
            }
            .pagination-btn.active {
                @apply bg-primary text-white border-primary;
            }
            .floating-btn {
                @apply fixed z-40 p-4 rounded-full shadow-lg transition-all duration-300 hover:scale-110 focus:outline-none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-dark">
    <!-- 悬浮跳转按钮 -->
    <button id="floatingJumpBtn" class="floating-btn right-6 top-1/2 -translate-y-1/2 bg-purple-500 text-white">
        <i class="fa fa-exchange text-xl"></i>
    </button>

    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-md sticky top-0 z-30 transition-all duration-300">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-wrap items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fa fa-bar-chart text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-dark">优先级数据处理系统</h1>
            </div>
            <div class="flex items-center space-x-4 mt-2 md:mt-0">
    <button id="templateBtn" class="flex items-center px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition-all">
        <i class="fa fa-download mr-2"></i>
        <span>下载模板</span>
    </button>
    <!-- 新增的快捷链接按钮 -->
    <a href="https://liwyat.github.io/extzhuanlaoyuangong/" target="_blank" class="flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all">
        <i class="fa fa-link mr-2"></i>
        <span>处理ext员工新账号为老员工</span>
    </a>
    <button id="helpBtn" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-full transition-all">
        <i class="fa fa-question-circle"></i>
    </button>
</div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 上传区域 -->
        <section class="mb-10 bg-white rounded-xl shadow-lg p-6 transform transition-all hover:shadow-xl">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                <i class="fa fa-upload text-primary mr-2"></i>
                导入Excel数据
            </h2>
            <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer">
                <i class="fa fa-file-excel-o text-5xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 mb-2">拖拽Excel文件到此处，或点击上传</p>
                <p class="text-gray-400 text-sm">请确保导入时，已在右上角工具处理过原ext员工新老员工数据</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden" />
                <button id="browseBtn" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all">
                    选择文件
                </button>
            </div>
            <div id="fileInfo" class="mt-4 hidden">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <i class="fa fa-file-text-o text-primary mr-2"></i>
                        <span id="fileName" class="truncate max-w-md"></span>
                    </div>
                    <button id="removeFileBtn" class="text-gray-500 hover:text-danger p-2 transition-colors">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 处理结果区域 -->
        <section id="resultsSection" class="hidden">
            <!-- 数据概览 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4 transform transition-all hover:shadow-md">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">总记录数</p>
                            <p id="totalRecords" class="text-2xl font-bold mt-1">0</p>
                        </div>
                        <div class="p-2 bg-primary/10 rounded-lg">
                            <i class="fa fa-users text-primary"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 transform transition-all hover:shadow-md">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">老员工数</p>
                            <p id="oldStaffCount" class="text-2xl font-bold mt-1">0</p>
                        </div>
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <i class="fa fa-user text-blue-500"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 transform transition-all hover:shadow-md">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">新员工数</p>
                            <p id="newStaffCount" class="text-2xl font-bold mt-1">0</p>
                        </div>
                        <div class="p-2 bg-green-100 rounded-lg">
                            <i class="fa fa-user-plus text-green-500"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 transform transition-all hover:shadow-md">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">第一梯队数</p>
                            <p id="firstTierCount" class="text-2xl font-bold mt-1">0</p>
                        </div>
                        <div class="p-2 bg-secondary/10 rounded-lg">
                            <i class="fa fa-trophy text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 部门梯队统计信息 -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">部门梯队统计【新员工（默认解决率影响值计算）先选择计算方式后查看数据】</h3>
                <div id="departmentTierStatistics" class="space-y-4">
                    <p class="text-gray-500">导入数据后显示部门统计信息</p>
                </div>
            </div>
            
            <!-- 部门小组梯队统计信息 -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2">部门小组梯队统计【新员工（默认解决率影响值计算）先选择计算方式后再点击生成统计】</h3>
                <div class="flex mb-4">
                    <select id="groupDeptSelector" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 mr-2">
                        <option value="">请选择五级部门</option>
                    </select>
                    <button id="generateGroupStatsBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all">
                        生成统计
                    </button>
                </div>
                <div id="departmentGroupTierStatistics" class="space-y-4">
                    <p class="text-gray-500">选择部门并点击生成统计按钮后显示小组统计信息</p>
                </div>
            </div>

            <!-- 功能按钮区域 -->
            <div class="mb-6 flex flex-wrap gap-4 justify-center">
                <button id="jumpBtn" class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all shadow flex items-center">
                    <i class="fa fa-exchange mr-2"></i>
                    <span>跳转至新员工数据</span>
                </button>
                <button id="exportOldBtn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all shadow flex items-center">
                    <i class="fa fa-download mr-2"></i>
                    <span>导出老员工Excel</span>
                </button>
                <button id="exportNewBtn" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all shadow flex items-center">
                    <i class="fa fa-download mr-2"></i>
                    <span>导出新员工Excel</span>
                </button>
                <button id="exportOldImageBtn" class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-all shadow flex items-center">
                    <i class="fa fa-picture-o mr-2"></i>
                    <span>导出老员工图片</span>
                </button>
                <button id="exportNewImageBtn" class="px-6 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition-all shadow flex items-center">
                    <i class="fa fa-picture-o mr-2"></i>
                    <span>导出新员工图片</span>
                </button>
            </div>

            <!-- 老员工处理 -->
            <div id="oldStaffSection" class="mb-8 bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-6 border-b border-gray-100">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="fa fa-user text-blue-500 mr-2"></i>
                        老员工数据处理
                    </h2>
                </div>
                
                <!-- 老员工搜索和筛选 -->
                <div class="p-6 bg-gray-50 border-b border-gray-100">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">搜索 (ERP账号/姓名)</label>
                            <div class="relative">
                                <input type="text" id="oldStaffSearch" placeholder="输入ERP账号或姓名搜索..."
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 pl-10">
                                <i class="fa fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">部门筛选（接待量降序）</label>
                            <select id="oldDeptFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="">全部部门</option>
                                <option value="1">SOHO运营四组京喜在线一组</option>
                                <option value="2">SOHO运营四组京喜在线二组</option>
                                <option value="3">SOHO运营四组京喜在线三组</option>
                                <option value="4">SOHO运营四组京喜在线四组</option>
                                <option value="5">SOHO运营四组京喜在线五组</option>
                                <option value="6">SOHO运营四组京喜在线六组</option>
                                <option value="7">SOHO运营四组京喜在线七组</option>
                                <option value="8">SOHO运营四组京喜在线八组</option>
                            </select>
                        </div>
                        <div>
                    <label class="block text-sm text-gray-600 mb-1">小组筛选（接待量降序）</label>
                    <div class="relative">
                        <button id="oldGroupFilterButton" type="button" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <span id="oldGroupFilterText">全部小组</span>
                            <span class="fa fa-chevron-down"></span>
                        </button>
                        <div id="oldGroupFilterDropdown" class="hidden absolute z-10 left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            <div class="p-2 border-b border-gray-100">
                                <input type="text" id="oldGroupFilterSearch" placeholder="搜索小组..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                            <div id="oldGroupFilterOptions" class="p-1"></div>
                        </div>
                        <input type="hidden" id="oldGroupFilter" value="">
                    </div>
                </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">梯队筛选（接待量降序）</label>
                            <select id="oldTierFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="">全部梯队</option>
                                <option value="1">第一梯队</option>
                                <option value="2">第二梯队</option>
                                <option value="3">第三梯队</option>
                            </select>
                        </div>
                        <div>
                <label class="block text-sm text-gray-600 mb-1">差异值筛选（筛选对应指标降序）</label>
                <div class="flex gap-2">
                    <input type="number" id="diffThreshold" value="5" min="1" max="100" 
                        class="w-16 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <select id="diffTypeFilter" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="">不筛选</option>
                        <option value="satisfaction">满意度差异值</option>
                        <option value="resolution">解决率差异值</option>
                        <option value="evaluation">解决率总评价量差异值</option>
                    </select>
                </div>
            </div>
                    </div>
                </div>
                
                <!-- 老员工计算方式选择 -->
                <div class="p-6 bg-gray-50 border-b border-gray-100">
                    <h3 class="font-medium mb-4">计算方式选择</h3>
                    <div class="flex flex-wrap gap-4 mb-6">
                        <button id="processByTargetBtn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all shadow flex items-center">
                            <i class="fa fa-bullseye mr-2"></i>
                            <span>按目标值计算</span>
                        </button>
                    </div>
                    
                    <!-- 按目标值计算设置 -->
                    <div id="targetSettings" class="mb-6">
                        <h4 class="font-medium mb-4">目标值设置</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">满意度第一梯队目标值（修改默认值联系@liguoping.26）</label>
                                <div class="relative">
                                    <input type="number" id="oldSatisfactionTarget" value="86.5" step="0.1" min="0" max="100" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 pr-10">
                                    <span class="absolute right-3 top-2 text-gray-500">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">解决率第一梯队目标值（修改默认值联系@liguoping.26）</label>
                                <div class="relative">
                                    <input type="number" id="oldResolutionTarget" value="78" step="0.1" min="0" max="100"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 pr-10">
                                    <span class="absolute right-3 top-2 text-gray-500">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">满意度第三梯队门槛值（修改默认值联系@liguoping.26）</label>
                                <div class="relative">
                                    <input type="number" id="oldSatisfactionThreshold" value="78.5" step="0.1" min="0" max="100"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 pr-10">
                                    <span class="absolute right-3 top-2 text-gray-500">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">解决率第三梯队门槛值（修改默认值联系@liguoping.26）</label>
                                <div class="relative">
                                    <input type="number" id="oldResolutionThreshold" value="72" step="0.1" min="0" max="100"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 pr-10">
                                    <span class="absolute right-3 top-2 text-gray-500">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">评价量样本量目标值（修改默认值联系@liguoping.26）</label>
                                <input type="number" id="oldEvaluationTarget" value="5" min="1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">解决率总评价量样本量目标值（低于此值直接划入第二梯队，修改默认值联系@liguoping.26）</label>
                                <input type="number" id="oldResolutionEvaluationTarget" value="5" min="1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 按目标值计算设置已完成 -->
                </div>
                
                <!-- 老员工结果 -->
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-medium">处理结果</h3>
                        <div class="text-sm text-gray-500">
                            第一梯队: <span id="oldFirstTierCount" class="text-secondary font-medium">0</span> / 
                            第二梯队: <span id="oldSecondTierCount" class="text-warning font-medium">0</span> / 
                            第三梯队: <span id="oldThirdTierCount" class="text-danger font-medium">0</span>
                            <span class="mx-1">|</span>
                            总计: <span id="oldTotalCount" class="font-medium">0</span>
                            <span class="ml-2 text-xs text-gray-400">(跟随筛选)</span>
                        </div>
                    </div>
                    
                    <!-- 分页控制 -->
                    <div id="oldPagination" class="mb-4 flex flex-wrap items-center justify-between">
                        <div class="text-sm text-gray-500 mb-2 md:mb-0">
                            显示 <span id="oldStartRecord">0</span>-<span id="oldEndRecord">0</span> 条，共 <span id="oldTotalFiltered">0</span> 条
                        </div>
                        <div class="flex items-center space-x-1">
                            <button id="oldPrevPage" class="pagination-btn" disabled>
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <div id="oldPageNumbers" class="flex items-center space-x-1"></div>
                            <button id="oldNextPage" class="pagination-btn" disabled>
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto table-shadow rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr id="oldStaffTableHeader"></tr>
                            </thead>
                            <tbody id="oldStaffTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    
                    <!-- 表格底部分页 -->
                    <div class="mt-4 flex flex-wrap items-center justify-between">
                        <div class="text-sm text-gray-500 mb-2 md:mb-0">
                            显示 <span id="oldStartRecordBottom">0</span>-<span id="oldEndRecordBottom">0</span> 条，共 <span id="oldTotalFilteredBottom">0</span> 条
                        </div>
                        <div class="flex items-center space-x-1">
                            <button id="oldPrevPageBottom" class="pagination-btn" disabled>
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <div id="oldPageNumbersBottom" class="flex items-center space-x-1"></div>
                            <button id="oldNextPageBottom" class="pagination-btn" disabled>
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 新员工处理 -->
            <div id="newStaffSection" class="mb-8 bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-6 border-b border-gray-100">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="fa fa-user-plus text-green-500 mr-2"></i>
                        新员工数据处理【默认为按解决率影响值计算】
                    </h2>
                </div>
                
                <!-- 新员工搜索和筛选 -->
                <div class="p-6 bg-gray-50 border-b border-gray-100">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">搜索 (ERP账号/姓名)</label>
                            <div class="relative">
                                <input type="text" id="newStaffSearch" placeholder="输入ERP账号或姓名搜索..."
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 pl-10">
                                <i class="fa fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">部门筛选</label>
                            <select id="newDeptFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="">全部部门</option>
                                <option value="1">SOHO运营四组京喜在线一组</option>
                                <option value="2">SOHO运营四组京喜在线二组</option>
                                <option value="3">SOHO运营四组京喜在线三组</option>
                                <option value="4">SOHO运营四组京喜在线四组</option>
                                <option value="5">SOHO运营四组京喜在线五组</option>
                                <option value="6">SOHO运营四组京喜在线六组</option>
                                <option value="7">SOHO运营四组京喜在线七组</option>
                                <option value="8">SOHO运营四组京喜在线八组</option>
                            </select>
                        </div>
                        <div>
                    <label class="block text-sm text-gray-600 mb-1">小组筛选（接待量降序）</label>
                    <div class="relative">
                        <button id="newGroupFilterButton" type="button" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <span id="newGroupFilterText">全部小组</span>
                            <span class="fa fa-chevron-down"></span>
                        </button>
                        <div id="newGroupFilterDropdown" class="hidden absolute z-10 left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            <div class="p-2 border-b border-gray-100">
                                <input type="text" id="newGroupFilterSearch" placeholder="搜索小组..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            </div>
                            <div id="newGroupFilterOptions" class="p-1"></div>
                        </div>
                        <input type="hidden" id="newGroupFilter" value="">
                    </div>
                </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">梯队筛选</label>
                            <select id="newTierFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="">全部梯队</option>
                                <option value="1">第一梯队</option>
                                <option value="2">第二梯队</option>
                                <option value="3">第三梯队</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 新员工目标值设置 -->
                <div class="p-6 bg-gray-50 border-b border-gray-100">
                    <h3 class="font-medium mb-4">目标值设置</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">新人影响值计算满意度目标值（修改默认值联系@liguoping.26）</label>
                            <div class="relative">
                                <input type="number" id="newSatisfactionTarget" value="82.5" step="0.1" min="0" max="100"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 pr-10">
                                <span class="absolute right-3 top-2 text-gray-500">%</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">用于计算满意度影响值的基准值</p>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">解决率目标值（修改默认值联系@liguoping.26）</label>
                            <div class="relative">
                                <input type="number" id="newResolutionTarget" value="78" step="0.1" min="0" max="100"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 pr-10">
                                <span class="absolute right-3 top-2 text-gray-500">%</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">第一梯队人数</label>
                            <input type="number" id="newFirstTierCount" value="100" min="1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <p class="text-xs text-gray-500 mt-1">满意度影响值前N名为第一梯队</p>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">第三梯队人数</label>
                            <input type="number" id="newThirdTierCount" value="50" min="1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <p class="text-xs text-gray-500 mt-1">满意度影响值倒数N名为第三梯队</p>
                        </div>
                    </div>
                    <button id="processNewStaffByResolutionBtn" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all mr-2">
                        <i class="fa fa-refresh mr-1"></i> 按解决率影响值计算梯队
                    </button>
                    <button id="processNewStaffBySatisfactionBtn" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all">
                        <i class="fa fa-refresh mr-1"></i> 按满意度影响值计算梯队
                    </button>
                </div>
                
                <!-- 新员工结果 -->
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-medium">处理结果</h3>
                        <div class="text-sm text-gray-500">
                            第一梯队: <span id="newFirstTierCountDisplay" class="text-secondary font-medium">0</span> / 
                            第二梯队: <span id="newSecondTierCount" class="text-warning font-medium">0</span> / 
                            第三梯队: <span id="newThirdTierCountDisplay" class="text-danger font-medium">0</span>
                            <span class="mx-1">|</span>
                            总计: <span id="newTotalCount" class="font-medium">0</span>
                            <span class="ml-2 text-xs text-gray-400">(跟随筛选)</span>
                        </div>
                    </div>
                    
                    <!-- 分页控制 -->
                    <div id="newPagination" class="mb-4 flex flex-wrap items-center justify-between">
                        <div class="text-sm text-gray-500 mb-2 md:mb-0">
                            显示 <span id="newStartRecord">0</span>-<span id="newEndRecord">0</span> 条，共 <span id="newTotalFiltered">0</span> 条
                        </div>
                        <div class="flex items-center space-x-1">
                            <button id="newPrevPage" class="pagination-btn" disabled>
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <div id="newPageNumbers" class="flex items-center space-x-1"></div>
                            <button id="newNextPage" class="pagination-btn" disabled>
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto table-shadow rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr id="newStaffTableHeader"></tr>
                            </thead>
                            <tbody id="newStaffTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    
                    <!-- 表格底部分页 -->
                    <div class="mt-4 flex flex-wrap items-center justify-between">
                        <div class="text-sm text-gray-500 mb-2 md:mb-0">
                            显示 <span id="newStartRecordBottom">0</span>-<span id="newEndRecordBottom">0</span> 条，共 <span id="newTotalFilteredBottom">0</span> 条
                        </div>
                        <div class="flex items-center space-x-1">
                            <button id="newPrevPageBottom" class="pagination-btn" disabled>
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <div id="newPageNumbersBottom" class="flex items-center space-x-1"></div>
                            <button id="newNextPageBottom" class="pagination-btn" disabled>
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xl font-semibold">使用帮助</h3>
                <button id="closeHelpBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <h4 class="font-medium mb-2">1. 导入数据</h4>
                <p class="text-gray-600 mb-4">导出数据时请选择原表格式-对应梯队计算周期的数据，点击"选择文件"按钮或拖拽Excel文件到上传区域，系统支持.xlsx和.xls格式文件。Excel必须包含"新老员工"字段用于区分人员类型，且完成ext人员转换。表头需与模板一致。</p>
                
                <h4 class="font-medium mb-2">2. 数据查询与筛选</h4>
                <ul class="text-gray-600 list-disc pl-5 mb-4">
                    <li>可通过ERP账号或姓名搜索特定员工</li>
                    <li>可通过部门筛选器筛选特定部门的员工数据</li>
                    <li>可通过梯队筛选器筛选特定梯队的员工数据</li>
                    <li>筛选后的数据会实时更新，导出功能也会只导出筛选后的数据</li>
                </ul>
                
                <h4 class="font-medium mb-2">3. 新老员工数据计算方式</h4>
                <ul class="text-gray-600 list-disc pl-5 mb-4">
                    <li><strong>老员工：按目标值计算</strong>：
                    <li>第一梯队：IM满意度和解决率均达到挑战值就是第一梯队</li>
                    <li>第三梯队：2个指标均未达成门槛值或者1个没达到门槛且另1个指标没达到挑战值</li>
                    <li>第二梯队：非第一梯队和第三梯队的人都是第二梯队</li>
                    <li><strong>新员工：按影响值排名计算</strong>：
                    <li>第一梯队：影响值新人排名前100就是第一梯队</li>
                    <li>第三梯队：影响值新人排名倒数50就是第三梯队</li>
                    <li>第二梯队：非第一梯队和第三梯队的人都是第二梯队</li>
                </ul>
                
                <h4 class="font-medium mb-2">4. 分页浏览</h4>
                <p class="text-gray-600 mb-4">系统默认每页显示100条数据，可通过表格上方和下方的分页控件切换页码，方便浏览大量数据。</p>
                
                <h4 class="font-medium mb-2">5. 数据导出</h4>
                <ul class="text-gray-600 list-disc pl-5 mb-4">
                    <li>可将数据导出为Excel格式，包含完整数据</li>
                    <li>可将所有筛选后的表格数据导出为图片格式，方便分享</li>
                </ul>
                
                <h4 class="font-medium mb-2">6. 快速跳转</h4>
                <p class="text-gray-600">点击顶部的"跳转至新员工数据"按钮或页面右侧的悬浮按钮，可在老员工和新员工数据区域之间快速切换。</p>
            </div>
        </div>
    </div>

    <!-- 临时图片导出容器 (隐藏) -->
    <div id="imageExportContainer" class="hidden absolute opacity-0 z-[-1] pointer-events-none"></div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-6">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p>优先级数据处理系统 &copy; 2025</p>
            <p class="text-gray-400 text-sm mt-1">@liguoping.26</p>
        </div>
    </footer>

    <script>
        // 全局变量
        let originalData = [];
        let processedOldStaff = [];
        let processedNewStaff = [];
        let originalHeaders = [];
        let oldStaffFiltered = [];
        let newStaffFiltered = [];
        let jumpToNewStaff = true; // 用于切换跳转方向
        const PAGE_SIZE = 100; // 每页显示100行
        let oldCurrentPage = 1;
        let newCurrentPage = 1;
        let oldCalculationMethod = 'target'; // 'target' 或 'score'

        // DOM 元素
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const uploadArea = document.getElementById('uploadArea');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const resultsSection = document.getElementById('resultsSection');
        const exportOldBtn = document.getElementById('exportOldBtn');
        const exportNewBtn = document.getElementById('exportNewBtn');
        const exportOldImageBtn = document.getElementById('exportOldImageBtn');
        const exportNewImageBtn = document.getElementById('exportNewImageBtn');
        const jumpBtn = document.getElementById('jumpBtn');
        const floatingJumpBtn = document.getElementById('floatingJumpBtn');
        const templateBtn = document.getElementById('templateBtn');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        const processByTargetBtn = document.getElementById('processByTargetBtn');
        const targetSettings = document.getElementById('targetSettings');
        const processNewStaffBtn = document.getElementById('processNewStaffBtn');
        const oldStaffSearch = document.getElementById('oldStaffSearch');
        const newStaffSearch = document.getElementById('newStaffSearch');
        const oldDeptFilter = document.getElementById('oldDeptFilter');
        const newDeptFilter = document.getElementById('newDeptFilter');
        const oldTierFilter = document.getElementById('oldTierFilter');
        const newTierFilter = document.getElementById('newTierFilter');
        const diffThreshold = document.getElementById('diffThreshold');
        const diffTypeFilter = document.getElementById('diffTypeFilter');
        const oldStaffSection = document.getElementById('oldStaffSection');
        const newStaffSection = document.getElementById('newStaffSection');
        const imageExportContainer = document.getElementById('imageExportContainer');

        // 分页相关元素
        const oldPrevPage = document.getElementById('oldPrevPage');
        const oldNextPage = document.getElementById('oldNextPage');
        const oldPageNumbers = document.getElementById('oldPageNumbers');
        const oldStartRecord = document.getElementById('oldStartRecord');
        const oldEndRecord = document.getElementById('oldEndRecord');
        const oldTotalFiltered = document.getElementById('oldTotalFiltered');
        const oldPrevPageBottom = document.getElementById('oldPrevPageBottom');
        const oldNextPageBottom = document.getElementById('oldNextPageBottom');
        const oldPageNumbersBottom = document.getElementById('oldPageNumbersBottom');
        const oldStartRecordBottom = document.getElementById('oldStartRecordBottom');
        const oldEndRecordBottom = document.getElementById('oldEndRecordBottom');
        const oldTotalFilteredBottom = document.getElementById('oldTotalFilteredBottom');

        const newPrevPage = document.getElementById('newPrevPage');
        const newNextPage = document.getElementById('newNextPage');
        const newPageNumbers = document.getElementById('newPageNumbers');
        const newStartRecord = document.getElementById('newStartRecord');
        const newEndRecord = document.getElementById('newEndRecord');
        const newTotalFiltered = document.getElementById('newTotalFiltered');
        const newPrevPageBottom = document.getElementById('newPrevPageBottom');
        const newNextPageBottom = document.getElementById('newNextPageBottom');
        const newPageNumbersBottom = document.getElementById('newPageNumbersBottom');
        const newStartRecordBottom = document.getElementById('newStartRecordBottom');
        const newEndRecordBottom = document.getElementById('newEndRecordBottom');
        const newTotalFilteredBottom = document.getElementById('newTotalFilteredBottom');

        // 初始化事件监听
        function initEventListeners() {
            console.log('初始化事件监听器...');
        }
        
        // 移除重复的DOMContentLoaded事件监听器，避免重复初始化
        
        // 为了兼容性，也添加window.onload事件
        window.addEventListener('load', function() {
            // 如果事件监听器还没有被初始化，则初始化
            if (!window._eventListenersInitialized) {
                initEventListeners();
                window._eventListenersInitialized = true;
                console.log('通过window.onload初始化事件监听器');
            }
        });
        
        // 为了防止上述方法都失败，立即尝试初始化
        setTimeout(function() {
            if (!window._eventListenersInitialized && document.readyState === 'complete') {
                initEventListeners();
                window._eventListenersInitialized = true;
                console.log('通过setTimeout初始化事件监听器');
            }
        }, 100);
        
        // 重新定义initEventListeners函数（覆盖上面的定义）
        function initEventListeners() {
            
            // 重新获取元素以确保它们存在
            const browseBtnElement = document.getElementById('browseBtn');
            const fileInputElement = document.getElementById('fileInput');
            
            console.log('browseBtn元素:', browseBtnElement);
            console.log('fileInput元素:', fileInputElement);
            
            // 文件上传相关
            if (browseBtnElement && fileInputElement) {
                // 先移除可能存在的旧事件监听器
                browseBtnElement.onclick = null;
                
                // 添加新的事件监听器
                browseBtnElement.addEventListener('click', function(event) {
                    event.stopPropagation();
                    console.log('点击了选择文件按钮');
                    // 使用try-catch确保代码执行不中断
                    try {
                        fileInputElement.click();
                        console.log('成功触发fileInput.click()');
                    } catch (error) {
                        console.error('触发fileInput.click()失败:', error);
                    }
                });
                
                // 确保uploadArea也能正常工作
                const uploadAreaElement = document.getElementById('uploadArea');
                if (uploadAreaElement) {
                    uploadAreaElement.addEventListener('click', function(event) {
                        // 只有当点击的是uploadArea本身而不是其子元素时才触发
                        if (event.target === uploadAreaElement || event.target === uploadAreaElement.querySelector('p') || event.target === uploadAreaElement.querySelector('i')) {
                            fileInputElement.click();
                        }
                    });
                }
                
                // 添加文件选择变化事件监听器
                fileInputElement.addEventListener('change', function(event) {
                    console.log('文件选择发生变化，触发handleFileUpload');
                    // 确保只处理一个文件
                    if (event.target.files && event.target.files.length > 0) {
                        handleFileUpload(event);
                    }
                });
                
                // 添加拖放功能支持
                if (uploadAreaElement) {
                    uploadAreaElement.addEventListener('dragover', handleDragOver);
                    uploadAreaElement.addEventListener('dragleave', function() {
                        uploadAreaElement.classList.remove('border-primary');
                    });
                    uploadAreaElement.addEventListener('drop', handleDrop);
                }
            } else {
                console.error('未找到browseBtn或fileInput元素');
            }
            
            // 标记事件监听器已初始化
            window._eventListenersInitialized = true;
            
            // 移除文件按钮
            if (removeFileBtn) {
                removeFileBtn.addEventListener('click', removeFile);
            } else {
                console.error('未找到removeFileBtn元素');
            }
            
            // 老员工计算按钮
            if (processByTargetBtn) {
                processByTargetBtn.addEventListener('click', () => {
                    oldCalculationMethod = 'target';
                    if (targetSettings) {
                        targetSettings.classList.remove('hidden');
                    }
                    processOldStaffByTarget();
                });
            } else {
                console.error('未找到processByTargetBtn元素');
            }
            
            // 按目标值计算已设置为唯一计算方式
            
            // 处理按钮 - 替换为具体的影响值计算按钮
            // processNewStaffBtn已不存在，使用具体的计算按钮事件
            const resolutionBtn = document.getElementById('processNewStaffByResolutionBtn');
            if (resolutionBtn) {
                resolutionBtn.addEventListener('click', function() {
                    window.currentImpactField = '解决率影响值';
                    processNewStaff();
                });
            } else {
                console.error('未找到processNewStaffByResolutionBtn元素');
            }
            
            document.getElementById('processNewStaffBySatisfactionBtn').addEventListener('click', function() {
                window.currentImpactField = '满意度影响值';
                processNewStaff();
            });
            
            // 导出按钮
            exportOldBtn.addEventListener('click', () => exportResults('old'));
            exportNewBtn.addEventListener('click', () => exportResults('new'));
            exportOldImageBtn.addEventListener('click', () => exportAsImage('old'));
            exportNewImageBtn.addEventListener('click', () => exportAsImage('new'));
            
            // 跳转按钮
            jumpBtn.addEventListener('click', toggleJump);
            floatingJumpBtn.addEventListener('click', toggleJump);
            
            // 搜索和筛选
            oldStaffSearch.addEventListener('input', () => {
                oldCurrentPage = 1; // 重置为第一页
                filterOldStaff();
            });
            oldDeptFilter.addEventListener('change', () => {
                oldCurrentPage = 1; // 重置为第一页
                filterOldStaff();
            });
            oldTierFilter.addEventListener('change', () => {
                oldCurrentPage = 1; // 重置为第一页
                filterOldStaff();
            });
            diffThreshold.addEventListener('change', () => {
                oldCurrentPage = 1; // 重置为第一页
                filterOldStaff();
            });
            diffTypeFilter.addEventListener('change', () => {
                oldCurrentPage = 1; // 重置为第一页
                filterOldStaff();
            });
            newDeptFilter.addEventListener('change', () => {
                newCurrentPage = 1; // 重置为第一页
                filterNewStaff();
            });
            newTierFilter.addEventListener('change', () => {
                newCurrentPage = 1; // 重置为第一页
                filterNewStaff();
            });
            
            // 分页控制
            oldPrevPage.addEventListener('click', () => goToOldPage(oldCurrentPage - 1));
            oldNextPage.addEventListener('click', () => goToOldPage(oldCurrentPage + 1));
            oldPrevPageBottom.addEventListener('click', () => goToOldPage(oldCurrentPage - 1));
            oldNextPageBottom.addEventListener('click', () => goToOldPage(oldCurrentPage + 1));
            
            newPrevPage.addEventListener('click', () => goToNewPage(newCurrentPage - 1));
            newNextPage.addEventListener('click', () => goToNewPage(newCurrentPage + 1));
            newPrevPageBottom.addEventListener('click', () => goToNewPage(newCurrentPage - 1));
            newNextPageBottom.addEventListener('click', () => goToNewPage(newCurrentPage + 1));
            
            // 模板下载
            templateBtn.addEventListener('click', downloadTemplate);
            
            // 帮助模态框
            helpBtn.addEventListener('click', () => helpModal.classList.replace('hidden', 'flex'));
            closeHelpBtn.addEventListener('click', () => helpModal.classList.replace('flex', 'hidden'));
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.classList.replace('flex', 'hidden');
                }
            });

            // 初始隐藏悬浮按钮
            floatingJumpBtn.classList.add('hidden');
        }

        // 添加分值范围
        function addScoreRange(type) {
            const container = type === 'satisfaction' ? satisfactionScoreRanges : resolutionScoreRanges;
            const newRange = document.createElement('div');
            newRange.className = 'score-range-item grid grid-cols-1 md:grid-cols-3 gap-4 mb-3 p-3 bg-gray-50 rounded';
            newRange.innerHTML = `
                <div>
                    <label class="block text-sm text-gray-600 mb-1">最小值 (%)</label>
                    <input type="number" class="min-value w-full px-3 py-2 border border-gray-300 rounded-lg" value="0" step="0.1" min="0" max="100">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">最大值 (%)</label>
                    <input type="number" class="max-value w-full px-3 py-2 border border-gray-300 rounded-lg" value="0" step="0.1" min="0" max="100">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">分值</label>
                    <input type="number" class="score w-full px-3 py-2 border border-gray-300 rounded-lg" value="1" min="1">
                </div>
            `;
            container.appendChild(newRange);
        }

        // 处理文件上传
        function handleFileUpload(e) {
            console.log('文件选择事件触发');
            const file = e.target.files[0];
            if (file) {
                console.log('选择的文件:', file.name);
                processFile(file);
            }
        }

        // 处理拖放
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('border-primary');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('border-primary');
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
                processFile(file);
            }
        }

        // 处理文件
        function processFile(file) {
            // 显示文件信息
            fileName.textContent = file.name;
            fileInfo.classList.remove('hidden');
            
            // 读取Excel文件
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    let jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // 为每个员工添加小组信息
                    jsonData = jsonData.map(item => {
                        // 确保优先使用客服账号进行匹配，因为staffGroupMap中的键是客服账号格式
                        let group = '';
                        
                        // 首先尝试使用客服账号进行精确匹配
                        if (item['客服账号']) {
                            const csAccount = String(item['客服账号']).trim();
                            group = staffGroupMap[csAccount] || '';
                        }
                        
                        // 如果客服账号匹配失败，尝试其他字段
                        if (!group) {
                            // 尝试使用ERP账号
                            if (item['ERP账号']) {
                                const erpAccount = String(item['ERP账号']).trim();
                                group = staffGroupMap[erpAccount] || '';
                            }
                        }
                        
                        // 构建增强后的员工对象
                        return {
                            ...item,
                            // 添加小组信息
                            '小组': group
                        };
                    });
                    
                    // 检查是否包含"新老员工"字段
                    if (jsonData.length > 0 && !jsonData[0].hasOwnProperty('新老员工')) {
                        alert('导入的Excel文件必须包含"新老员工"字段用于区分人员类型！');
                        removeFile();
                        return;
                    }
                    
                    // 保存原始数据
                    originalData = jsonData;
                    originalHeaders = Object.keys(jsonData[0] || {});
                    
                    // 处理数据
                    processAllData();
                    
                    // 显示结果区域和悬浮按钮
                    resultsSection.classList.remove('hidden');
                    floatingJumpBtn.classList.remove('hidden');
                    
                    // 初始化时默认按目标值计算
                    processByTargetBtn.click();
                } catch (error) {
                    alert('文件解析错误: ' + error.message);
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 处理所有数据 - 根据"新老员工"字段区分
        function processAllData() {
            // 首先区分原始的老员工和新员工数据
            const originalOldStaff = originalData.filter(item => 
                item['新老员工'] && item['新老员工'].toString().trim() === '老员工'
            );
            const originalNewStaff = originalData.filter(item => 
                item['新老员工'] && item['新老员工'].toString().trim() === '新员工'
            );
            
            // 创建新员工ERP账号到数据的映射，用于快速查找
            const newStaffMap = new Map();
            originalNewStaff.forEach(item => {
                if (item['ERP账号']) {
                    newStaffMap.set(item['ERP账号'], item);
                }
            });
            
            // 处理老员工数据，合并同一ERP账号的新老员工数据
            processedOldStaff = originalOldStaff.map(oldStaff => {
                const erp = oldStaff['ERP账号'];
                // 如果老员工的ERP账号在新员工中有对应数据，则合并
                if (erp && newStaffMap.has(erp)) {
                    const newStaff = newStaffMap.get(erp);
                    // 复制老员工数据作为基础
                    const mergedStaff = { ...oldStaff };
                    
                    // 合并数值型数据（求和）
                    // 接待量
                    if (newStaff['接待量'] !== undefined && oldStaff['接待量'] !== undefined) {
                        mergedStaff['接待量'] = (parseFloat(oldStaff['接待量']) || 0) + (parseFloat(newStaff['接待量']) || 0);
                    }
                    // 满意量_剔除R
                    if (newStaff['满意量_剔除R'] !== undefined && oldStaff['满意量_剔除R'] !== undefined) {
                        mergedStaff['满意量_剔除R'] = (parseFloat(oldStaff['满意量_剔除R']) || 0) + (parseFloat(newStaff['满意量_剔除R']) || 0);
                    }
                    // 评价量_剔除R
                    if (newStaff['评价量_剔除R'] !== undefined && oldStaff['评价量_剔除R'] !== undefined) {
                        mergedStaff['评价量_剔除R'] = (parseFloat(oldStaff['评价量_剔除R']) || 0) + (parseFloat(newStaff['评价量_剔除R']) || 0);
                    }
                    // 已解决量_剔除R
                    if (newStaff['已解决量_剔除R'] !== undefined && oldStaff['已解决量_剔除R'] !== undefined) {
                        mergedStaff['已解决量_剔除R'] = (parseFloat(oldStaff['已解决量_剔除R']) || 0) + (parseFloat(newStaff['已解决量_剔除R']) || 0);
                    }
                    // 解决率总评价量_剔除R
                    if (newStaff['解决率总评价量_剔除R'] !== undefined && oldStaff['解决率总评价量_剔除R'] !== undefined) {
                        mergedStaff['解决率总评价量_剔除R'] = (parseFloat(oldStaff['解决率总评价量_剔除R']) || 0) + (parseFloat(newStaff['解决率总评价量_剔除R']) || 0);
                    }
                    
                    // 重新计算满意度：满意量之和/评价量之和
                    const totalSatisfactionCount = parseFloat(mergedStaff['满意量_剔除R']) || 0;
                    const totalEvaluationCount = parseFloat(mergedStaff['评价量_剔除R']) || 0;
                    if (totalEvaluationCount > 0) {
                        mergedStaff['满意度_剔除R'] = totalSatisfactionCount / totalEvaluationCount;
                    }
                    
                    // 重新计算解决率：已解决量之和/解决率总评价量之和
                    const totalResolvedCount = parseFloat(mergedStaff['已解决量_剔除R']) || 0;
                    const totalResolutionEvaluationCount = parseFloat(mergedStaff['解决率总评价量_剔除R']) || 0;
                    if (totalResolutionEvaluationCount > 0) {
                        mergedStaff['解决率_剔除R'] = totalResolvedCount / totalResolutionEvaluationCount;
                    }
                    
                    // 标记为已合并数据
                    mergedStaff['isMergedData'] = true;
                    
                    return mergedStaff;
                }
                return oldStaff;
            });
            
            // 筛选出新员工中不与老员工ERP账号重复的数据
            processedNewStaff = originalNewStaff.filter(item => {
                const erp = item['ERP账号'];
                // 如果新员工的ERP账号在老员工中存在，则不保留该新员工数据
                return !erp || !originalOldStaff.some(oldStaff => oldStaff['ERP账号'] === erp);
            });
            
            // 初始化部门筛选器
            initDepartmentFilters();
            
            // 计算统计信息
            updateStatistics();
            // 更新部门梯队统计
            updateDepartmentTierStatistics();
            
            // 初始化currentImpactField为解决率影响值（上传文件后的默认计算方式）
            window.currentImpactField = '解决率影响值';
            
            // 文件上传后自动计算新员工梯队（按照解决率影响值）
            processNewStaff();
            console.log('文件数据已加载完成，已自动按解决率影响值计算新员工梯队');
        }

        // 按目标值处理老员工数据
        function processOldStaffByTarget() {
            const satisfactionTarget = parseFloat(document.getElementById('oldSatisfactionTarget').value) / 100;
            const resolutionTarget = parseFloat(document.getElementById('oldResolutionTarget').value) / 100;
            const satisfactionThreshold = parseFloat(document.getElementById('oldSatisfactionThreshold').value) / 100;
            const resolutionThreshold = parseFloat(document.getElementById('oldResolutionThreshold').value) / 100;
            const evaluationTarget = parseInt(document.getElementById('oldEvaluationTarget').value);
            const resolutionEvaluationTarget = parseInt(document.getElementById('oldResolutionEvaluationTarget').value);
            
            processedOldStaff = processedOldStaff.map(staff => {
                // 将数值转换为整数（接待量、满意量_剔除R、评价量_剔除R、已解决量_剔除R）
                // 确保所有数值都被正确转换为整数，不保留小数点
                if (staff['接待量'] !== undefined) staff['接待量'] = Math.floor(parseFloat(staff['接待量']) || 0);
                if (staff['满意量_剔除R'] !== undefined) staff['满意量_剔除R'] = Math.floor(parseFloat(staff['满意量_剔除R']) || 0);
                if (staff['评价量_剔除R'] !== undefined) staff['评价量_剔除R'] = Math.floor(parseFloat(staff['评价量_剔除R']) || 0);
                if (staff['已解决量_剔除R'] !== undefined) staff['已解决量_剔除R'] = Math.floor(parseFloat(staff['已解决量_剔除R']) || 0);
                
                // 计算是否达到各项目标（完善空值处理和精度比较）
                const satisfactionValue = staff['满意度_剔除R'] || 0;
                const resolutionValue = staff['解决率_剔除R'] || 0;
                const satisfactionEvaluation = staff['评价量_剔除R'] || 0;
                const resolutionEvaluation = staff['解决率总评价量_剔除R'] || 0;
                
                // 使用更精确的达标判断，确保等于目标值时也能正确识别
                const satisfaction达标 = Math.abs(satisfactionValue - satisfactionTarget) < 0.00001 || satisfactionValue > satisfactionTarget;
                const resolution达标 = Math.abs(resolutionValue - resolutionTarget) < 0.00001 || resolutionValue > resolutionTarget;
                const satisfaction未达门槛 = satisfactionValue < satisfactionThreshold;
                const resolution未达门槛 = resolutionValue < resolutionThreshold;
                const evaluation达标 = satisfactionEvaluation >= evaluationTarget;
                const resolutionEvaluation达标 = resolutionEvaluation >= resolutionEvaluationTarget;
                
                // 优化后的梯队判断逻辑
                // 优先级最高：解决率总评价量_剔除R小于5直接划入第二梯队
                const isLowEvaluation = resolutionEvaluation < 5;
                
                // 梯队判断逻辑
                // 满意度和解决率均大于等于目标值且不是低评价量的员工才能进入第一梯队
                const isFirstTier = !isLowEvaluation && satisfaction达标 && resolution达标;
                
                // 定义第三梯队的三个判断条件
                // 条件1: 满意度小于满意度第三梯队门槛值 并且 解决率小于解决率第三梯队门槛值
                const condition1 = satisfaction未达门槛 && resolution未达门槛;
                // 条件2: 解决率小于解决率第三梯队门槛值 并且 满意度小于满意度第一梯队目标值
                const condition2 = resolution未达门槛 && !satisfaction达标;
                // 条件3: 满意度小于满意度第三梯队门槛值 并且 解决率小于解决率第一梯队目标值
                const condition3 = satisfaction未达门槛 && !resolution达标;
                
                // 第三梯队判断：满足任一条件且不是低评价量的员工
                const isThirdTier = !isLowEvaluation && (condition1 || condition2 || condition3);
                
                // 首先检查是否因评价量少直接划入第二梯队，或者不属于第一梯队和第三梯队
                const isSecondTier = isLowEvaluation || (!isFirstTier && !isThirdTier);
                
                // 确定最终梯队
                const tier = isFirstTier ? 1 : (isThirdTier ? 3 : 2);
                
                // 计算差距（达标时留空）
                const satisfaction差距 = satisfaction达标 ? '' : satisfactionTarget - staff['满意度_剔除R'];
                const resolution差距 = resolution达标 ? '' : resolutionTarget - staff['解决率_剔除R'];
                const evaluation差距 = evaluation达标 ? '' : evaluationTarget - staff['评价量_剔除R'];
                const resolutionEvaluation差距 = resolutionEvaluation达标 ? '' : resolutionEvaluationTarget - staff['解决率总评价量_剔除R'];
                
                // 计算差异量（达标时留空）
                let satisfaction差异量 = '';
                let resolution差异量 = '';
                
                // 只有未达标时才计算差异量
                if (!satisfaction达标 && 1 - satisfactionTarget !== 0) {
                    // 满意度差异量 = 评价量_剔除R × (满意度_剔除R目标值 - 满意度_剔除R) ÷ (1 - 满意度_剔除R目标值)
                    satisfaction差异量 = Math.round(staff['评价量_剔除R'] * (satisfactionTarget - staff['满意度_剔除R']) / (1 - satisfactionTarget));
                }
                
                // 只有未达标时才计算差异量
                if (!resolution达标 && 1 - resolutionTarget !== 0) {
                    // 解决率差异量 = 解决率总评价量_剔除R × (解决率_剔除R目标值 - 解决率_剔除R) ÷ (1 - 解决率_剔除R目标值)
                    resolution差异量 = Math.round(staff['解决率总评价量_剔除R'] * (resolutionTarget - staff['解决率_剔除R']) / (1 - resolutionTarget));
                }
                
                // 计算未达原因（保持原有逻辑）
                const reasons = [];
                if (!satisfaction达标) reasons.push(`满意度未达标 (差距: ${(satisfaction差距 * 100).toFixed(1)}%, 差异量: ${satisfaction差异量})`);
                if (!resolution达标) reasons.push(`解决率未达标 (差距: ${(resolution差距 * 100).toFixed(1)}%, 差异量: ${resolution差异量})`);
                if (!evaluation达标) reasons.push(`评价量未达标 (差距: ${evaluation差距})`);
                if (!resolutionEvaluation达标) reasons.push(`解决率总评价量未达标 (差距: ${resolutionEvaluation差距})`);
                
                return {
                    ...staff,
                    isFirstTier,
                    isSecondTier,
                    isThirdTier,
                    tier,
                    未达标项: {
                        satisfaction: !satisfaction达标,
                        resolution: !resolution达标,
                        evaluation: !evaluation达标,
                        resolutionEvaluation: !resolutionEvaluation达标
                    },
                    差距值: {
                        satisfaction: satisfaction差距,
                        resolution: resolution差距,
                        evaluation: evaluation差距,
                        resolutionEvaluation: resolutionEvaluation差距
                    },
                    满意度差异量: satisfaction差异量,
                    解决率差异量: resolution差异量,
                    非第一梯队原因: reasons.join('; ')
                };
            });
            
            // 筛选并更新表格
            filterOldStaff();
            updateOldStaffTable();
            updateStatistics();
            updateDepartmentTierStatistics();
        }

        // 已删除按分值计算相关函数

        // 处理新员工数据
        function processNewStaff() {
            const satisfactionTarget = parseFloat(document.getElementById('newSatisfactionTarget').value) / 100;
            const resolutionTarget = parseFloat(document.getElementById('newResolutionTarget').value) / 100;
            const firstTierCount = parseInt(document.getElementById('newFirstTierCount').value);
            const thirdTierCount = parseInt(document.getElementById('newThirdTierCount').value);
            // 从外部传入的当前影响值计算字段，默认为解决率影响值
            const currentImpactField = window.currentImpactField || '解决率影响值';
            
            // 计算满意度影响值和解决率影响值并排序
            // 先计算所有新员工的"评价量_剔除R"和"解决率总评价量_剔除R"总和
const totalEvaluationCount = processedNewStaff.reduce((sum, staff) => {
    const evalCount = parseFloat(staff['评价量_剔除R']) || 0;
    return sum + evalCount;
}, 0);

const totalResolutionEvaluationCount = processedNewStaff.reduce((sum, staff) => {
    const evalCount = parseFloat(staff['解决率总评价量_剔除R']) || 0;
    return sum + evalCount;
}, 0);

// 计算并添加满意度影响值和解决率影响值
let staffWithImpact = processedNewStaff.map(staff => {
    const satisfaction = parseFloat(staff['满意度_剔除R']) || 0;
    const evalCount = parseFloat(staff['评价量_剔除R']) || 0;
    const resolution = parseFloat(staff['解决率_剔除R']) || 0;
    const resolutionEvalCount = parseFloat(staff['解决率总评价量_剔除R']) || 0;
    
    // 计算满意度影响值（处理除以0的情况）
    let satisfactionImpactValue = 0;
    if (totalEvaluationCount > 0) {
        satisfactionImpactValue = (satisfaction - satisfactionTarget) * (evalCount / totalEvaluationCount);
    }
    
    // 计算解决率影响值（处理除以0的情况）
    let resolutionImpactValue = 0;
    if (totalResolutionEvaluationCount > 0) {
        resolutionImpactValue = (resolution - resolutionTarget) * (resolutionEvalCount / totalResolutionEvaluationCount);
    }
    
    return {
        ...staff,
        满意度影响值: parseFloat(satisfactionImpactValue.toFixed(6)), // 保留6位小数避免精度问题
        解决率影响值: parseFloat(resolutionImpactValue.toFixed(6)) // 保留6位小数避免精度问题
    };
});

// 根据当前影响值字段排序（上传文件后的默认计算方式）
            staffWithImpact.sort((a, b) => b[currentImpactField] - a[currentImpactField]);
            
            // 确定梯队
            const totalStaff = staffWithImpact.length;
            const thirdTierStartIndex = Math.max(0, totalStaff - thirdTierCount);
            
            processedNewStaff = staffWithImpact.map((staff, index) => {
                let tier = 2; // 默认第二梯队
                
                if (index < firstTierCount) {
                    tier = 1; // 第一梯队
                } else if (index >= thirdTierStartIndex) {
                    tier = 3; // 第三梯队
                }
                
                // 计算未达第一梯队原因
                let reason = '';
                if (tier !== 1) {
                    // 根据当前影响值字段动态显示原因
                    const impactFieldText = currentImpactField === '满意度影响值' ? '满意度影响值' : '解决率影响值';
                    if (tier === 3) {
                        reason = impactFieldText + '属于后' + thirdTierCount + '名，属于第三梯队';
                    } else {
                        reason = impactFieldText + '未进入前' + firstTierCount + '名';
                    }
                }
                
                return {
                    ...staff,
                    isFirstTier: tier === 1,
                    isSecondTier: tier === 2,
                    isThirdTier: tier === 3,
                    tier,
                    非第一梯队原因: reason
                };
            });
            
            // 筛选并更新表格
            filterNewStaff();
            updateNewStaffTable();
            updateStatistics();
            updateDepartmentTierStatistics();
        }

        // 初始化部门筛选器
        function initDepartmentFilters() {
            // 收集所有部门
            const departments = new Set();
            originalData.forEach(item => {
                if (item.五级部门) departments.add(item.五级部门);
            });
            
            // 清空现有选项（保留"全部部门"）
            while (oldDeptFilter.options.length > 1) {
                oldDeptFilter.remove(1);
            }
            while (newDeptFilter.options.length > 1) {
                newDeptFilter.remove(1);
            }
            
            // 添加部门选项
            departments.forEach(dept => {
                const option1 = document.createElement('option');
                option1.value = dept;
                option1.textContent = dept;
                oldDeptFilter.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = dept;
                option2.textContent = dept;
                newDeptFilter.appendChild(option2);
            });
            
            // 获取所有小组并按接待量降序排序
            const allGroups = [...new Set(processedOldStaff.concat(processedNewStaff).map(staff => staff['小组']))];
            
            // 初始化弹出框选择器
            initDropdownSelector(
                'oldGroupFilterButton',
                'oldGroupFilterDropdown',
                'oldGroupFilterSearch',
                'oldGroupFilterOptions',
                'oldGroupFilter',
                'oldGroupFilterText',
                allGroups
            );
            
            initDropdownSelector(
                'newGroupFilterButton',
                'newGroupFilterDropdown',
                'newGroupFilterSearch',
                'newGroupFilterOptions',
                'newGroupFilter',
                'newGroupFilterText',
                allGroups
            );
            
            // 初始化部门变更事件，用于更新小组筛选器
            initGroupFilters();
        }
        
        // 初始化小组筛选器
        function initGroupFilters() {
            // 老员工部门变更事件
            oldDeptFilter.addEventListener('change', function() {
                updateGroupFilterOptions(this.value, 'oldGroupFilter', processedOldStaff);
            });
            
            // 新员工部门变更事件
            newDeptFilter.addEventListener('change', function() {
                updateGroupFilterOptions(this.value, 'newGroupFilter', processedNewStaff);
            });
        }
        
        // 初始化弹出框选择器
        function initDropdownSelector(buttonId, dropdownId, searchId, optionsId, filterId, textId, groups) {
            const button = document.getElementById(buttonId);
            const dropdown = document.getElementById(dropdownId);
            const search = document.getElementById(searchId);
            const optionsContainer = document.getElementById(optionsId);
            const filterInput = document.getElementById(filterId);
            const textElement = document.getElementById(textId);
            
            // 存储选中的小组
            let selectedGroups = [];
            
            // 切换下拉框显示状态
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
                
                // 隐藏其他下拉框
                const otherDropdowns = document.querySelectorAll('[id$="GroupFilterDropdown"]');
                otherDropdowns.forEach(d => {
                    if (d.id !== dropdownId) {
                        d.classList.add('hidden');
                    }
                });
            });
            
            // 点击页面其他地方关闭下拉框
            document.addEventListener('click', () => {
                dropdown.classList.add('hidden');
            });
            
            // 防止点击下拉框内容时关闭
            dropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // 生成选项
            function generateOptions(filteredGroups) {
                optionsContainer.innerHTML = '';
                filteredGroups.forEach(group => {
                    const isSelected = selectedGroups.includes(group);
                    const optionDiv = document.createElement('div');
                    optionDiv.className = `p-2 hover:bg-gray-100 cursor-pointer flex items-center ${isSelected ? 'bg-gray-200' : ''}`;
                    optionDiv.innerHTML = `
                        <input type="checkbox" id="${buttonId}-${group}" value="${group}" ${isSelected ? 'checked' : ''} class="mr-2">
                        <label for="${buttonId}-${group}" class="cursor-pointer flex-1">${group}</label>
                    `;
                    
                    const checkbox = optionDiv.querySelector('input[type="checkbox"]');
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            selectedGroups.push(group);
                        } else {
                            selectedGroups = selectedGroups.filter(g => g !== group);
                        }
                        updateSelectedText();
                        updateFilterInput();
                    });
                    
                    optionsContainer.appendChild(optionDiv);
                });
            }
            
            // 更新显示的选中文本
            function updateSelectedText() {
                if (selectedGroups.length === 0) {
                    textElement.textContent = '全部小组';
                } else if (selectedGroups.length <= 3) {
                    textElement.textContent = selectedGroups.join(', ');
                } else {
                    textElement.textContent = `${selectedGroups.length} 个小组已选择`;
                }
            }
            
            // 更新隐藏输入框的值
            function updateFilterInput() {
                filterInput.value = selectedGroups.join(',');
                
                // 触发筛选函数
                if (buttonId === 'oldGroupFilterButton') {
                    filterOldStaff();
                } else if (buttonId === 'newGroupFilterButton') {
                    filterNewStaff();
                }
            }
            
            // 搜索功能
            search.addEventListener('input', () => {
                const searchTerm = search.value.toLowerCase();
                const filteredGroups = groups.filter(group => 
                    group.toLowerCase().includes(searchTerm)
                );
                generateOptions(filteredGroups);
            });
            
            // 初始化选项（按接待量降序）
            generateOptions(groups);
            
            // 添加清空按钮
            const clearButton = document.createElement('div');
            clearButton.className = 'p-2 text-center text-blue-600 hover:bg-gray-100 cursor-pointer font-medium';
            clearButton.textContent = '清空选择';
            clearButton.addEventListener('click', () => {
                selectedGroups = [];
                generateOptions(groups);
                updateSelectedText();
                updateFilterInput();
            });
            optionsContainer.appendChild(clearButton);
        }
        
        // 更新小组筛选选项
        function updateGroupFilterOptions(selectedDept, filterId, staffData) {
            // 收集小组数据，并按接待量降序排序
            const groupsWithVolume = {};
            
            if (selectedDept) {
                // 按部门筛选小组
                staffData.forEach(item => {
                    if (item.五级部门 === selectedDept && item['小组']) {
                        const group = item['小组'];
                        if (!groupsWithVolume[group]) {
                            groupsWithVolume[group] = 0;
                        }
                        // 累加接待量
                        groupsWithVolume[group] += parseInt(item['接待量'] || 0);
                    }
                });
            } else {
                // 所有部门的小组
                staffData.forEach(item => {
                    if (item['小组']) {
                        const group = item['小组'];
                        if (!groupsWithVolume[group]) {
                            groupsWithVolume[group] = 0;
                        }
                        // 累加接待量
                        groupsWithVolume[group] += parseInt(item['接待量'] || 0);
                    }
                });
            }
            
            // 转换为数组并按接待量降序排序
            const sortedGroups = Object.keys(groupsWithVolume).sort((a, b) => {
                return groupsWithVolume[b] - groupsWithVolume[a];
            });
            
            // 根据筛选器ID初始化相应的下拉选择器
            if (filterId === 'oldGroupFilter') {
                initDropdownSelector(
                    'oldGroupFilterButton',
                    'oldGroupFilterDropdown',
                    'oldGroupFilterSearch',
                    'oldGroupFilterOptions',
                    'oldGroupFilter',
                    'oldGroupFilterText',
                    sortedGroups
                );
            } else if (filterId === 'newGroupFilter') {
                initDropdownSelector(
                    'newGroupFilterButton',
                    'newGroupFilterDropdown',
                    'newGroupFilterSearch',
                    'newGroupFilterOptions',
                    'newGroupFilter',
                    'newGroupFilterText',
                    sortedGroups
                );
            }
        }

        // 筛选老员工数据
        function filterOldStaff() {
            const searchTerm = oldStaffSearch.value.toLowerCase();
            const deptFilter = oldDeptFilter.value;
            const tierFilter = oldTierFilter.value;
            const diffThreshold = parseInt(document.getElementById('diffThreshold').value);
            const diffTypeFilter = document.getElementById('diffTypeFilter').value;
            
            // 先进行基础筛选
            let filtered = processedOldStaff.filter(staff => {
                // 搜索筛选
                const matchesSearch = 
                    (!searchTerm) || 
                    (staff['ERP账号'] && staff['ERP账号'].toString().toLowerCase().includes(searchTerm)) ||
                    (staff['姓名'] && staff['姓名'].toLowerCase().includes(searchTerm));
                
                // 部门筛选
                const matchesDept = !deptFilter || staff['五级部门'] === deptFilter;
                
                // 梯队筛选
                const matchesTier = !tierFilter || staff.tier === parseInt(tierFilter);
                
                // 小组筛选
                const groupFilterValue = document.getElementById('oldGroupFilter').value;
                const selectedGroups = groupFilterValue ? groupFilterValue.split(',') : [];
                const matchesGroup = selectedGroups.length === 0 || selectedGroups.includes(staff['小组'] || '');
                
                return matchesSearch && matchesDept && matchesTier && matchesGroup;
            });
            
            // 差异值筛选
            if (diffTypeFilter) {
                // 根据差异类型筛选出有差异值且其他两个指标达标的员工
                if (diffTypeFilter === 'satisfaction') {
                    // 筛选满意度差异值，且解决率_剔除R、解决率总评价量_剔除R均达标
                    filtered = filtered.filter(s => {
                        // 必须有满意度差异值且满足阈值条件
                        const hasSatisfactionDiff = s['满意度差异量'] !== '' && 
                                                 typeof s['满意度差异量'] === 'number' && 
                                                 s['满意度差异量'] <= diffThreshold;
                        
                        // 解决率必须达标：差异量为空字符串表示达标
                        const resolution达标 = s['解决率差异量'] === '';
                        
                        // 解决率总评价量必须达标：差距值为空字符串表示达标
                        const resolutionEvaluation达标 = (!s['差距值'] || 
                                                         !s['差距值']['resolutionEvaluation'] || 
                                                         s['差距值']['resolutionEvaluation'] === '');
                        
                        return hasSatisfactionDiff && resolution达标 && resolutionEvaluation达标;
                    }).sort((a, b) => (b['满意度_剔除R'] || 0) - (a['满意度_剔除R'] || 0));
                } else if (diffTypeFilter === 'resolution') {
                    // 筛选解决率差异值，且满意度_剔除R、解决率总评价量_剔除R均达标
                    filtered = filtered.filter(s => {
                        // 必须有解决率差异值且满足阈值条件
                        const hasResolutionDiff = s['解决率差异量'] !== '' && 
                                                 typeof s['解决率差异量'] === 'number' && 
                                                 s['解决率差异量'] <= diffThreshold;
                        
                        // 满意度必须达标：差异量为空字符串表示达标
                        const satisfaction达标 = s['满意度差异量'] === '';
                        
                        // 解决率总评价量必须达标：差距值为空字符串表示达标
                        const resolutionEvaluation达标 = (!s['差距值'] || 
                                                         !s['差距值']['resolutionEvaluation'] || 
                                                         s['差距值']['resolutionEvaluation'] === '');
                        
                        return hasResolutionDiff && satisfaction达标 && resolutionEvaluation达标;
                    }).sort((a, b) => (b['解决率_剔除R'] || 0) - (a['解决率_剔除R'] || 0));
                } else if (diffTypeFilter === 'evaluation') {
                    // 筛选解决率总评价量差异值，且满意度_剔除R、解决率_剔除R均达标
                    filtered = filtered.filter(s => {
                        // 必须有解决率总评价量差异值且满足阈值条件
                        const hasEvaluationDiff = s['差距值'] && 
                                                 s['差距值']['resolutionEvaluation'] !== '' && 
                                                 typeof s['差距值']['resolutionEvaluation'] === 'number' && 
                                                 s['差距值']['resolutionEvaluation'] <= diffThreshold;
                        
                        // 满意度必须达标：差异量为空字符串表示达标
                        const satisfaction达标 = s['满意度差异量'] === '';
                        
                        // 解决率必须达标：差异量为空字符串表示达标
                        const resolution达标 = s['解决率差异量'] === '';
                        
                        return hasEvaluationDiff && satisfaction达标 && resolution达标;
                    }).sort((a, b) => (b['解决率总评价量_剔除R'] || 0) - (a['解决率总评价量_剔除R'] || 0));
                }
            }
            
            oldStaffFiltered = filtered;
            
            // 更新分页
            updateOldPagination();
            // 更新表格
            updateOldStaffTable();
            // 更新统计信息
            updateOldStaffStatistics();
        }

        // 筛选新员工数据
        function filterNewStaff() {
            const searchTerm = newStaffSearch.value.toLowerCase();
            const deptFilter = newDeptFilter.value;
            const tierFilter = newTierFilter.value;
            
            newStaffFiltered = processedNewStaff.filter(staff => {
                // 搜索筛选
                const matchesSearch = 
                    (!searchTerm) || 
                    (staff['ERP账号'] && staff['ERP账号'].toString().toLowerCase().includes(searchTerm)) ||
                    (staff['姓名'] && staff['姓名'].toLowerCase().includes(searchTerm));
                
                // 部门筛选
                const matchesDept = !deptFilter || staff['五级部门'] === deptFilter;
                
                // 梯队筛选
                const matchesTier = !tierFilter || staff.tier === parseInt(tierFilter);
                
                // 小组筛选
                const groupFilterValue = document.getElementById('newGroupFilter').value;
                const selectedGroups = groupFilterValue ? groupFilterValue.split(',') : [];
                const matchesGroup = selectedGroups.length === 0 || selectedGroups.includes(staff['小组'] || '');
                
                return matchesSearch && matchesDept && matchesTier && matchesGroup;
            });
            
            // 更新分页
            updateNewPagination();
            // 更新表格
            updateNewStaffTable();
            // 更新统计信息
            updateNewStaffStatistics();
        }

        // 更新老员工分页
        function updateOldPagination() {
            const totalPages = Math.ceil(oldStaffFiltered.length / PAGE_SIZE);
            
            // 确保当前页在有效范围内
            if (oldCurrentPage > totalPages) {
                oldCurrentPage = Math.max(1, totalPages);
            }
            
            // 更新分页信息
            const startRecord = (oldCurrentPage - 1) * PAGE_SIZE + 1;
            const endRecord = Math.min(oldCurrentPage * PAGE_SIZE, oldStaffFiltered.length);
            
            oldStartRecord.textContent = startRecord;
            oldEndRecord.textContent = endRecord;
            oldTotalFiltered.textContent = oldStaffFiltered.length;
            
            oldStartRecordBottom.textContent = startRecord;
            oldEndRecordBottom.textContent = endRecord;
            oldTotalFilteredBottom.textContent = oldStaffFiltered.length;
            
            // 更新分页按钮状态
            oldPrevPage.disabled = oldCurrentPage <= 1;
            oldNextPage.disabled = oldCurrentPage >= totalPages;
            oldPrevPageBottom.disabled = oldCurrentPage <= 1;
            oldNextPageBottom.disabled = oldCurrentPage >= totalPages;
            
            // 更新页码按钮
            updatePageNumbers(oldPageNumbers, totalPages, oldCurrentPage, 'old');
            updatePageNumbers(oldPageNumbersBottom, totalPages, oldCurrentPage, 'old');
        }

        // 更新新员工分页
        function updateNewPagination() {
            const totalPages = Math.ceil(newStaffFiltered.length / PAGE_SIZE);
            
            // 确保当前页在有效范围内
            if (newCurrentPage > totalPages) {
                newCurrentPage = Math.max(1, totalPages);
            }
            
            // 更新分页信息
            const startRecord = (newCurrentPage - 1) * PAGE_SIZE + 1;
            const endRecord = Math.min(newCurrentPage * PAGE_SIZE, newStaffFiltered.length);
            
            newStartRecord.textContent = startRecord;
            newEndRecord.textContent = endRecord;
            newTotalFiltered.textContent = newStaffFiltered.length;
            
            newStartRecordBottom.textContent = startRecord;
            newEndRecordBottom.textContent = endRecord;
            newTotalFilteredBottom.textContent = newStaffFiltered.length;
            
            // 更新分页按钮状态
            newPrevPage.disabled = newCurrentPage <= 1;
            newNextPage.disabled = newCurrentPage >= totalPages;
            newPrevPageBottom.disabled = newCurrentPage <= 1;
            newNextPageBottom.disabled = newCurrentPage >= totalPages;
            
            // 更新页码按钮
            updatePageNumbers(newPageNumbers, totalPages, newCurrentPage, 'new');
            updatePageNumbers(newPageNumbersBottom, totalPages, newCurrentPage, 'new');
        }

        // 更新页码按钮
        function updatePageNumbers(container, totalPages, currentPage, type) {
            container.innerHTML = '';
            
            // 最多显示10个页码
            const maxVisiblePages = 10;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = startPage + maxVisiblePages - 1;
            
            if (endPage > totalPages) {
                endPage = totalPages;
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // 添加第一页和省略号（如果需要）
            if (startPage > 1) {
                addPageButton(container, 1, currentPage, type);
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2';
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
            }
            
            // 添加可见页码
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(container, i, currentPage, type);
            }
            
            // 添加最后一页和省略号（如果需要）
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2';
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
                addPageButton(container, totalPages, currentPage, type);
            }
        }

        // 添加页码按钮
        function addPageButton(container, pageNum, currentPage, type) {
            const button = document.createElement('button');
            button.className = `pagination-btn ${pageNum === currentPage ? 'active' : ''}`;
            button.textContent = pageNum;
            button.addEventListener('click', () => {
                if (type === 'old') {
                    goToOldPage(pageNum);
                } else {
                    goToNewPage(pageNum);
                }
            });
            container.appendChild(button);
        }

        // 跳转到老员工指定页
        function goToOldPage(pageNum) {
            if (pageNum < 1 || pageNum > Math.ceil(oldStaffFiltered.length / PAGE_SIZE)) {
                return;
            }
            
            oldCurrentPage = pageNum;
            updateOldPagination();
            updateOldStaffTable();
            
            // 滚动到表格顶部
            document.getElementById('oldStaffSection').scrollIntoView({ behavior: 'smooth' });
        }

        // 跳转到新员工指定页
        function goToNewPage(pageNum) {
            if (pageNum < 1 || pageNum > Math.ceil(newStaffFiltered.length / PAGE_SIZE)) {
                return;
            }
            
            newCurrentPage = pageNum;
            updateNewPagination();
            updateNewStaffTable();
            
            // 滚动到表格顶部
            document.getElementById('newStaffSection').scrollIntoView({ behavior: 'smooth' });
        }

        // 更新老员工表格
        function updateOldStaffTable() {
            const tableHeader = document.getElementById('oldStaffTableHeader');
            const tableBody = document.getElementById('oldStaffTableBody');
            
            // 清空表格
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            // 如果没有数据，显示提示
            if (oldStaffFiltered.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="100%" class="text-center py-4 text-gray-500">没有找到匹配的老员工数据</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            // 计算当前页的数据
            const startIndex = (oldCurrentPage - 1) * PAGE_SIZE;
            const currentPageData = oldStaffFiltered.slice(startIndex, startIndex + PAGE_SIZE);
            
            // 获取表头（使用第一条数据的键）
            const headers = Object.keys(currentPageData[0]);
            
            // 定义字段顺序：梯队在前，非第一梯队原因在后，排除差异量字段
            let customHeaders = [
                '梯队', 
                ...headers.filter(h => !['isFirstTier', 'isSecondTier', 'isThirdTier', 'tier', '未达标项', '差距值', '非第一梯队原因', '满意度差异量', '解决率差异量'].includes(h)),
                '非第一梯队原因'
            ];
            
            // 重新排序：将小组字段放在五级部门后面
            if (customHeaders.includes('五级部门') && customHeaders.includes('小组')) {
                const deptIndex = customHeaders.indexOf('五级部门');
                const groupIndex = customHeaders.indexOf('小组');
                
                // 如果小组不在五级部门后面，进行调整
                if (groupIndex !== deptIndex + 1) {
                    // 移除小组并在五级部门后重新插入
                    customHeaders.splice(groupIndex, 1);
                    customHeaders.splice(deptIndex + 1, 0, '小组');
                }
            }
            
            // 创建表头
            customHeaders.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = formatHeader(header);
                tableHeader.appendChild(th);
            });
            
            // 创建表格内容
            currentPageData.forEach(staff => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors';
                
                // 添加梯队单元格
                const tierTd = document.createElement('td');
                tierTd.className = 'px-6 py-4 whitespace-nowrap text-sm';
                
                if (staff.tier === 1) {
                    tierTd.className += ' first-tier';
                    tierTd.textContent = '第一梯队';
                } else if (staff.tier === 2) {
                    tierTd.className += ' second-tier';
                    tierTd.textContent = '第二梯队';
                } else {
                    tierTd.className += ' third-tier';
                    tierTd.textContent = '第三梯队';
                }
                tr.appendChild(tierTd);
                
                // 添加其他字段（排除非第一梯队原因，后面单独处理）
                const otherHeaders = customHeaders.slice(1).filter(h => h !== '非第一梯队原因');
                otherHeaders.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                    
                    // 特殊处理需要高亮的字段
                    let isHighlighted = false;
                    let displayValue = staff[header];
                    
                    // 格式化数值
                    if (typeof displayValue === 'number') {
                        // 整数字段：解决率总评价量_剔除R、接待量、满意量_剔除R、评价量_剔除R、已解决量_剔除R
                        if (header === '解决率总评价量_剔除R' || 
                            header === '接待量' || 
                            header === '满意量_剔除R' || 
                            header === '评价量_剔除R' || 
                            header === '已解决量_剔除R') {
                            displayValue = displayValue.toFixed(0);
                        }
                        // 百分比字段
                        else if (header.includes('满意度') || header.includes('解决率')) {
                            displayValue = (displayValue * 100).toFixed(1) + '%';
                        }
                        // 分值字段
                        else if (header.includes('Score') || header.includes('分值')) {
                            displayValue = displayValue.toFixed(0);
                        }
                        // 其他数字保留两位小数
                        else {
                            displayValue = displayValue.toFixed(2);
                        }
                    }
                    
                    // 检查是否需要高亮显示（未达标项）
                    if (oldCalculationMethod === 'target' && staff.未达标项) {
                        if (header === '满意度_剔除R' && staff.未达标项.satisfaction) {
                            isHighlighted = true;
                            displayValue += ` (差距: ${(staff.差距值.satisfaction * 100).toFixed(1)}%, 差异量: ${staff.满意度差异量})`;
                        } else if (header === '解决率_剔除R' && staff.未达标项.resolution) {
                            isHighlighted = true;
                            displayValue += ` (差距: ${(staff.差距值.resolution * 100).toFixed(1)}%, 差异量: ${staff.解决率差异量})`;
                        } else if (header === '评价量_剔除R' && staff.未达标项.evaluation) {
                            isHighlighted = true;
                            displayValue += ` (差距: ${staff.差距值.evaluation})`;
                        } else if (header === '解决率总评价量_剔除R' && staff.未达标项.resolutionEvaluation) {
                            isHighlighted = true;
                            displayValue += ` (差距: ${staff.差距值.resolutionEvaluation})`;
                        }
                    }
                    
                    if (isHighlighted) {
                        td.className += ' highlight-cell';
                    }
                    
                    td.textContent = displayValue || '';
                    tr.appendChild(td);
                });
                
                // 添加非第一梯队原因字段
                const reasonTd = document.createElement('td');
                reasonTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                reasonTd.textContent = staff['非第一梯队原因'] || '';
                tr.appendChild(reasonTd);
                
                tableBody.appendChild(tr);
            });
            
            // 更新统计信息
            updateOldStaffStatistics();
        }

        // 更新新员工表格
        function updateNewStaffTable() {
            const tableHeader = document.getElementById('newStaffTableHeader');
            const tableBody = document.getElementById('newStaffTableBody');
            
            // 清空表格
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            // 如果没有数据，显示提示
            if (newStaffFiltered.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="100%" class="text-center py-4 text-gray-500">没有找到匹配的新员工数据</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            // 计算当前页的数据
            const startIndex = (newCurrentPage - 1) * PAGE_SIZE;
            const currentPageData = newStaffFiltered.slice(startIndex, startIndex + PAGE_SIZE);
            
            // 获取表头（使用第一条数据的键）
            const headers = Object.keys(currentPageData[0]);
            
            // 定义字段顺序：梯队在前，非第一梯队原因在后
            let customHeaders = [
                '梯队', 
                ...headers.filter(h => !['isFirstTier', 'isSecondTier', 'isThirdTier', 'tier', '非第一梯队原因'].includes(h)),
                '非第一梯队原因'
            ];
            
            // 重新排序：将小组字段放在五级部门后面
            if (customHeaders.includes('五级部门') && customHeaders.includes('小组')) {
                const deptIndex = customHeaders.indexOf('五级部门');
                const groupIndex = customHeaders.indexOf('小组');
                
                // 如果小组不在五级部门后面，进行调整
                if (groupIndex !== deptIndex + 1) {
                    // 移除小组并在五级部门后重新插入
                    customHeaders.splice(groupIndex, 1);
                    customHeaders.splice(deptIndex + 1, 0, '小组');
                }
            }
            
            // 创建表头
            customHeaders.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = formatHeader(header);
                tableHeader.appendChild(th);
            });
            
            // 创建表格内容
            currentPageData.forEach(staff => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors';
                
                // 添加梯队单元格
                const tierTd = document.createElement('td');
                tierTd.className = 'px-6 py-4 whitespace-nowrap text-sm';
                
                if (staff.tier === 1) {
                    tierTd.className += ' first-tier';
                    tierTd.textContent = '第一梯队';
                } else if (staff.tier === 2) {
                    tierTd.className += ' second-tier';
                    tierTd.textContent = '第二梯队';
                } else {
                    tierTd.className += ' third-tier';
                    tierTd.textContent = '第三梯队';
                }
                tr.appendChild(tierTd);
                
                // 添加其他字段（排除非第一梯队原因，后面单独处理）
                const otherHeaders = customHeaders.slice(1).filter(h => h !== '非第一梯队原因');
                otherHeaders.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                    
                    let displayValue = staff[header];
                    
                    // 格式化数值
                    if (typeof displayValue === 'number') {
                        // 满意度影响值和解决率影响值特殊处理：显示为数字格式，保留6位小数
                if (header === '满意度影响值' || header === '解决率影响值') {
                    displayValue = displayValue.toFixed(6);
                }
                        // 整数字段：解决率总评价量_剔除R、接待量、满意量_剔除R、评价量_剔除R、已解决量_剔除R
                        else if (header === '解决率总评价量_剔除R' || 
                                 header === '接待量' || 
                                 header === '满意量_剔除R' || 
                                 header === '评价量_剔除R' || 
                                 header === '已解决量_剔除R') {
                            displayValue = displayValue.toFixed(0);
                        }
                        // 百分比字段
                        else if (header.includes('满意度') || header.includes('解决率')) {
                            displayValue = (displayValue * 100).toFixed(1) + '%';
                        }
                        // 其他数字保留两位小数
                        else {
                            displayValue = displayValue.toFixed(2);
                        }
                    }
                    
                    td.textContent = displayValue || '';
                    tr.appendChild(td);
                });
                
                // 添加非第一梯队原因字段
                const reasonTd = document.createElement('td');
                reasonTd.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                reasonTd.textContent = staff['非第一梯队原因'] || '';
                tr.appendChild(reasonTd);
                
                tableBody.appendChild(tr);
            });
            
            // 更新统计信息
            updateNewStaffStatistics();
        }

        // 格式化表头
        function formatHeader(header) {
            // 去除表头中的"_剔除R"文本
            let formattedHeader = header.replace('_剔除R', '');
            
            switch(formattedHeader) {
                case 'satisfactionScore': return '满意度得分';
                case 'resolutionScore': return '解决率得分';
                case 'totalScore': return '总分值';
                default: return formattedHeader;
            }
        }

        // 更新老员工统计信息
        function updateOldStaffStatistics() {
            // 使用筛选后的数据进行统计
            const firstTierCount = oldStaffFiltered.filter(s => s.isFirstTier).length;
            const secondTierCount = oldStaffFiltered.filter(s => s.isSecondTier).length;
            const thirdTierCount = oldStaffFiltered.filter(s => s.isThirdTier).length;
            const totalCount = oldStaffFiltered.length;
            
            document.getElementById('oldFirstTierCount').textContent = firstTierCount;
            document.getElementById('oldSecondTierCount').textContent = secondTierCount;
            document.getElementById('oldThirdTierCount').textContent = thirdTierCount;
            document.getElementById('oldTotalCount').textContent = totalCount;
        }

        // 更新新员工统计信息
        function updateNewStaffStatistics() {
            // 使用筛选后的数据进行统计
            const firstTierCount = newStaffFiltered.filter(s => s.isFirstTier).length;
            const secondTierCount = newStaffFiltered.filter(s => s.isSecondTier).length;
            const thirdTierCount = newStaffFiltered.filter(s => s.isThirdTier).length;
            const totalCount = newStaffFiltered.length;
            
            document.getElementById('newFirstTierCountDisplay').textContent = firstTierCount;
            document.getElementById('newSecondTierCount').textContent = secondTierCount;
            document.getElementById('newThirdTierCountDisplay').textContent = thirdTierCount;
            document.getElementById('newTotalCount').textContent = totalCount;
        }

        // 更新部门梯队统计信息
        function updateDepartmentTierStatistics() {
            // 收集所有部门
            const departments = new Set();
            processedOldStaff.forEach(item => {
                if (item.五级部门) departments.add(item.五级部门);
            });
            processedNewStaff.forEach(item => {
                if (item.五级部门) departments.add(item.五级部门);
            });
            
            // 转换为数组并排序
            const departmentArray = Array.from(departments).sort();
            
            // 更新部门选择器（用于部门小组统计）
            const groupDeptSelector = document.getElementById('groupDeptSelector');
            groupDeptSelector.innerHTML = '<option value="">请选择五级部门</option>';
            departmentArray.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                groupDeptSelector.appendChild(option);
            });
            
            // 添加生成统计按钮事件
            document.getElementById('generateGroupStatsBtn').onclick = generateDepartmentGroupStatistics;
            
            // 预计算各梯队总计（用于占比计算）
            let grandTotalAllTier1 = 0, grandTotalAllTier2 = 0, grandTotalAllTier3 = 0;
            
            // 先计算总计
            departmentArray.forEach(dept => {
                // 老员工统计
                const oldStaffInDept = processedOldStaff.filter(staff => staff.五级部门 === dept);
                const oldTier1 = oldStaffInDept.filter(staff => staff.tier === 1).length;
                const oldTier2 = oldStaffInDept.filter(staff => staff.tier === 2).length;
                const oldTier3 = oldStaffInDept.filter(staff => staff.tier === 3).length;
                
                // 新员工统计
                const newStaffInDept = processedNewStaff.filter(staff => staff.五级部门 === dept);
                const newTier1 = newStaffInDept.filter(staff => staff.tier === 1).length;
                const newTier2 = newStaffInDept.filter(staff => staff.tier === 2).length;
                const newTier3 = newStaffInDept.filter(staff => staff.tier === 3).length;
                
                // 累加总计
                grandTotalAllTier1 += oldTier1 + newTier1;
                grandTotalAllTier2 += oldTier2 + newTier2;
                grandTotalAllTier3 += oldTier3 + newTier3;
            });
            
            // 创建表格HTML
            let statsHtml = `
                <table class="w-full border-collapse shadow-md rounded-lg overflow-hidden">
                <style>
                    #departmentTierStatistics table {
                        font-size: 14px;
                        line-height: 1.5;
                        border-radius: 8px;
                        overflow: hidden;
                    }
                    #departmentTierStatistics th, #departmentTierStatistics td {
                        border: 1px solid #e5e7eb;
                        padding: 10px 12px;
                        text-align: center;
                    }
                    #departmentTierStatistics th {
                        background: linear-gradient(to right, #f3f4f6, #e5e7eb);
                        font-weight: 600;
                        color: #374151;
                    }
                    #departmentTierStatistics tr:nth-child(even) {
                        background-color: #f9fafb;
                    }
                    #departmentTierStatistics tr:hover {
                        background-color: #f3f4f6;
                    }
                    #departmentTierStatistics tr:last-child {
                        background: linear-gradient(to right, #f3f4f6, #e5e7eb);
                        font-weight: bold;
                    }
                    .percentage-bar {
                        height: 20px;
                        background: linear-gradient(to right, #fca5a5, #ef4444);
                        border-radius: 10px;
                        position: relative;
                        overflow: hidden;
                    }
                    .percentage-text {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        color: white;
                        font-weight: bold;
                        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
                    }
                </style>
                    <thead>
                        <tr>
                            <th class="border p-2 text-left">组别</th>
                            <th colspan="4" class="border p-2 text-center">第一梯队</th>
                            <th colspan="4" class="border p-2 text-center">第二梯队</th>
                            <th colspan="4" class="border p-2 text-center">第三梯队</th>
                        </tr>
                        <tr>
                            <th class="border p-2 text-left"></th>
                            <th class="border p-2 text-center text-green-600">新人</th>
                            <th class="border p-2 text-center text-blue-600">老人</th>
                            <th class="border p-2 text-center font-bold">总计</th>
                            <th class="border p-2 text-center font-bold">占比</th>
                            <th class="border p-2 text-center text-green-600">新人</th>
                            <th class="border p-2 text-center text-blue-600">老人</th>
                            <th class="border p-2 text-center font-bold">总计</th>
                            <th class="border p-2 text-center font-bold">占比</th>
                            <th class="border p-2 text-center text-green-600">新人</th>
                            <th class="border p-2 text-center text-blue-600">老人</th>
                            <th class="border p-2 text-center font-bold">总计</th>
                            <th class="border p-2 text-center font-bold">占比</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 计算总计
            let grandTotalNewTier1 = 0, grandTotalOldTier1 = 0;
            let grandTotalNewTier2 = 0, grandTotalOldTier2 = 0;
            let grandTotalNewTier3 = 0, grandTotalOldTier3 = 0;
            
            // 添加每个部门的数据行
            departmentArray.forEach(dept => {
                // 老员工统计
                const oldStaffInDept = processedOldStaff.filter(staff => staff.五级部门 === dept);
                const oldTier1 = oldStaffInDept.filter(staff => staff.tier === 1).length;
                const oldTier2 = oldStaffInDept.filter(staff => staff.tier === 2).length;
                const oldTier3 = oldStaffInDept.filter(staff => staff.tier === 3).length;
                
                // 新员工统计
                const newStaffInDept = processedNewStaff.filter(staff => staff.五级部门 === dept);
                const newTier1 = newStaffInDept.filter(staff => staff.tier === 1).length;
                const newTier2 = newStaffInDept.filter(staff => staff.tier === 2).length;
                const newTier3 = newStaffInDept.filter(staff => staff.tier === 3).length;
                
                // 计算总计
                const allTier1 = oldTier1 + newTier1;
                const allTier2 = oldTier2 + newTier2;
                const allTier3 = oldTier3 + newTier3;
                
                // 计算占比
                const percentageTier1 = grandTotalAllTier1 > 0 ? ((allTier1 / grandTotalAllTier1) * 100).toFixed(1) : '0.0';
                const percentageTier2 = grandTotalAllTier2 > 0 ? ((allTier2 / grandTotalAllTier2) * 100).toFixed(1) : '0.0';
                const percentageTier3 = grandTotalAllTier3 > 0 ? ((allTier3 / grandTotalAllTier3) * 100).toFixed(1) : '0.0';
                
                // 累加总计
                grandTotalNewTier1 += newTier1;
                grandTotalOldTier1 += oldTier1;
                grandTotalNewTier2 += newTier2;
                grandTotalOldTier2 += oldTier2;
                grandTotalNewTier3 += newTier3;
                grandTotalOldTier3 += oldTier3;
                
                // 添加行
                statsHtml += `
                    <tr>
                        <td class="border p-2 font-medium text-left">${dept}</td>
                        <td class="border p-2 text-center text-green-600">${newTier1}</td>
                        <td class="border p-2 text-center text-blue-600">${oldTier1}</td>
                        <td class="border p-2 text-center font-bold">${allTier1}</td>
                        <td class="border p-2">
                            <div class="percentage-bar" style="width: ${Math.min(parseFloat(percentageTier1) * 5, 100)}%">
                                <div class="percentage-text">${percentageTier1}%</div>
                            </div>
                        </td>
                        <td class="border p-2 text-center text-green-600">${newTier2}</td>
                        <td class="border p-2 text-center text-blue-600">${oldTier2}</td>
                        <td class="border p-2 text-center font-bold">${allTier2}</td>
                        <td class="border p-2">
                            <div class="percentage-bar" style="width: ${Math.min(parseFloat(percentageTier2) * 5, 100)}%">
                                <div class="percentage-text">${percentageTier2}%</div>
                            </div>
                        </td>
                        <td class="border p-2 text-center text-green-600">${newTier3}</td>
                        <td class="border p-2 text-center text-blue-600">${oldTier3}</td>
                        <td class="border p-2 text-center font-bold">${allTier3}</td>
                        <td class="border p-2">
                            <div class="percentage-bar" style="width: ${Math.min(parseFloat(percentageTier3) * 5, 100)}%">
                                <div class="percentage-text">${percentageTier3}%</div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            // 添加总计行
            statsHtml += `
                    <tr>
                        <td class="border p-2 font-bold text-left">总计</td>
                        <td class="border p-2 text-center font-bold text-green-600">${grandTotalNewTier1}</td>
                        <td class="border p-2 text-center font-bold text-blue-600">${grandTotalOldTier1}</td>
                        <td class="border p-2 text-center font-bold">${grandTotalAllTier1}</td>
                        <td class="border p-2 text-center font-bold text-red-600">100.0%</td>
                        <td class="border p-2 text-center font-bold text-green-600">${grandTotalNewTier2}</td>
                        <td class="border p-2 text-center font-bold text-blue-600">${grandTotalOldTier2}</td>
                        <td class="border p-2 text-center font-bold">${grandTotalAllTier2}</td>
                        <td class="border p-2 text-center font-bold text-red-600">100.0%</td>
                        <td class="border p-2 text-center font-bold text-green-600">${grandTotalNewTier3}</td>
                        <td class="border p-2 text-center font-bold text-blue-600">${grandTotalOldTier3}</td>
                        <td class="border p-2 text-center font-bold">${grandTotalAllTier3}</td>
                        <td class="border p-2 text-center font-bold text-red-600">100.0%</td>
                    </tr>
                </tbody>
            </table>
            `;
            
            // 更新DOM
            const departmentStatsContainer = document.getElementById('departmentTierStatistics');
            if (departmentStatsContainer) {
                departmentStatsContainer.innerHTML = statsHtml || '<p class="text-gray-500">暂无数据</p>';
                
                // 绑定点击事件到部门统计表格中的数字
                bindTierNumberClickEvents(departmentStatsContainer, true);
            }
        }
        
        // 添加模态框HTML
        function addModalStructure() {
            // 检查模态框是否已存在
            if (document.getElementById('staffDetailModal')) return;
            
            // 添加模态框动画样式
            const style = document.createElement('style');
            style.textContent = `
                #staffDetailModal {
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }
                #staffDetailModal:not(.hidden) {
                    opacity: 1;
                }
                .modal-content-wrapper {
                    transform: scale(0.95);
                    opacity: 0;
                    transition: transform 0.3s ease, opacity 0.3s ease;
                }
                #staffDetailModal:not(.hidden) .modal-content-wrapper {
                    transform: scale(1);
                    opacity: 1;
                }
                .modal-loading {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    min-height: 200px;
                }
                .modal-loading::after {
                    content: '';
                    width: 40px;
                    height: 40px;
                    border: 3px solid #f3f3f3;
                    border-top: 3px solid #3b82f6;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            const modalHtml = `
                <div id="staffDetailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
                    <div class="modal-content-wrapper bg-white rounded-lg shadow-xl w-[90vw] max-w-[95%] max-h-[90vh] overflow-hidden">
                        <div class="bg-gray-100 px-6 py-4 border-b flex justify-between items-center">
                            <h3 id="modalTitle" class="text-lg font-bold text-gray-800">人员详情</h3>
                            <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none transition-colors">
                                <i class="fa fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-150px)]">
                            <div id="modalContent">
                                <div class="modal-loading"></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-6 py-4 border-t flex justify-end">
                            <button id="downloadTableBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mr-2 transition-colors">
                                <i class="fa fa-download mr-1"></i> 下载表格
                            </button>
                            <button id="closeModalBtnBottom" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition-colors">
                                关闭
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 绑定关闭模态框事件
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('closeModalBtnBottom').addEventListener('click', closeModal);
            
            // 点击模态框背景关闭
            const modal = document.getElementById('staffDetailModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
            
            // 键盘ESC关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        }
        
        // 绑定梯队数字点击事件
        function bindTierNumberClickEvents(container, isDepartment) {
            const numberCells = container.querySelectorAll('td.text-green-600, td.text-blue-600, td.font-bold:not(:first-child)');
            
            numberCells.forEach(cell => {
                const number = parseInt(cell.textContent.trim());
                if (!isNaN(number) && number > 0) {
                    cell.style.cursor = 'pointer';
                        cell.classList.add('hover:bg-blue-50', 'transition-all', 'duration-200');
                        cell.style.position = 'relative';
                        
                        // 添加点击涟漪效果的样式
                        const style = document.createElement('style');
                        style.textContent = `
                            .ripple-effect {
                                position: absolute;
                                border-radius: 50%;
                                background-color: rgba(59, 130, 246, 0.3);
                                transform: scale(0);
                                animation: ripple 0.6s ease-out;
                                pointer-events: none;
                            }
                            @keyframes ripple {
                                to {
                                    transform: scale(4);
                                    opacity: 0;
                                }
                            }
                        `;
                        document.head.appendChild(style);
                        
                        // 添加点击涟漪效果
                        cell.addEventListener('mousedown', function(e) {
                            const ripple = document.createElement('span');
                            const rect = this.getBoundingClientRect();
                            const size = Math.max(rect.width, rect.height);
                            const x = e.clientX - rect.left - size / 2;
                            const y = e.clientY - rect.top - size / 2;
                            
                            ripple.className = 'ripple-effect';
                            ripple.style.width = ripple.style.height = size + 'px';
                            ripple.style.left = x + 'px';
                            ripple.style.top = y + 'px';
                            
                            this.appendChild(ripple);
                            
                            setTimeout(() => {
                                this.removeChild(ripple);
                            }, 600);
                        });
                    
                    cell.addEventListener('click', function() {
                        const department = cell.parentElement.querySelector('td:first-child').textContent.trim();
                        const isTotalRow = department === '总计' || department === '合计';
                        
                        // 判断梯队类型
                        let tier, staffType;
                        const cellIndex = Array.from(cell.parentElement.children).indexOf(cell);
                        
                        // 根据列索引判断梯队和新老员工类型
                        if (cellIndex >= 1 && cellIndex <= 4) {
                            tier = 1;
                        } else if (cellIndex >= 5 && cellIndex <= 8) {
                            tier = 2;
                        } else if (cellIndex >= 9 && cellIndex <= 12) {
                            tier = 3;
                        }
                        
                        // 判断是新人、老人还是总计
                        if (cell.classList.contains('text-green-600')) {
                            staffType = '新员工';
                        } else if (cell.classList.contains('text-blue-600')) {
                            staffType = '老员工';
                        } else {
                            staffType = '总计';
                        }
                        
                        // 打开模态框显示人员数据
                        openStaffDetailModal(department, tier, staffType, isDepartment, isTotalRow);
                    });
                }
            });
        }
        
        // 关闭模态框
        function closeModal() {
            const modal = document.getElementById('staffDetailModal');
            if (modal) {
                modal.classList.add('hidden');
                // 移除window上挂载的分页函数，避免内存泄漏
                if (window.renderPage) {
                    delete window.renderPage;
                }
            }
        }
        
        // 生成部门小组梯队统计信息
        function generateDepartmentGroupStatistics() {
            const selectedDept = document.getElementById('groupDeptSelector').value;
            if (!selectedDept) {
                alert('请先选择一个五级部门');
                return;
            }
            
            // 收集该部门下的所有小组
            const groups = new Set();
            const staffInDept = [...processedOldStaff, ...processedNewStaff].filter(item => 
                item.五级部门 === selectedDept && item['小组']
            );
            staffInDept.forEach(item => {
                if (item['小组']) groups.add(item['小组']);
            });
            
            // 为每个小组统计各梯队新老员工数量
            const groupStats = {};
            groups.forEach(group => {
                groupStats[group] = {
                    newTier1: 0,
                    oldTier1: 0,
                    newTier2: 0,
                    oldTier2: 0,
                    newTier3: 0,
                    oldTier3: 0
                };
            });
            
            // 统计数据
            staffInDept.forEach(staff => {
                const group = staff['小组'];
                if (!group) return;
                
                if (staff.isFirstTier) {
                    if (staff['新老员工'] === '新员工') {
                        groupStats[group].newTier1++;
                    } else {
                        groupStats[group].oldTier1++;
                    }
                } else if (staff.isSecondTier) {
                    if (staff['新老员工'] === '新员工') {
                        groupStats[group].newTier2++;
                    } else {
                        groupStats[group].oldTier2++;
                    }
                } else if (staff.isThirdTier) {
                    if (staff['新老员工'] === '新员工') {
                        groupStats[group].newTier3++;
                    } else {
                        groupStats[group].oldTier3++;
                    }
                }
            });
            
            // 转换为数组并排序
            const groupArray = Array.from(groups).sort();
            
            // 计算该部门的总计（用于占比计算）
            const deptOldStaff = processedOldStaff.filter(item => item.五级部门 === selectedDept);
            const deptNewStaff = processedNewStaff.filter(item => item.五级部门 === selectedDept);
            const deptTotalTier1 = deptOldStaff.filter(s => s.tier === 1).length + deptNewStaff.filter(s => s.tier === 1).length;
            const deptTotalTier2 = deptOldStaff.filter(s => s.tier === 2).length + deptNewStaff.filter(s => s.tier === 2).length;
            const deptTotalTier3 = deptOldStaff.filter(s => s.tier === 3).length + deptNewStaff.filter(s => s.tier === 3).length;
            const deptTotal = deptTotalTier1 + deptTotalTier2 + deptTotalTier3;
            
            // 创建表格HTML
            let tableHTML = `
                <table class="w-full border-collapse shadow-md rounded-lg overflow-hidden">
                <style>
                    #departmentGroupTierStatistics table {
                        font-size: 14px;
                        line-height: 1.5;
                        border-radius: 8px;
                        border: 1px solid #e5e7eb;
                        overflow: hidden;
                        width: 100%;
                        background-color: white;
                    }
                    #departmentGroupTierStatistics th {
                        background-color: #f3f4f6;
                        color: #374151;
                        font-weight: 600;
                        text-align: center;
                        padding: 0.75rem;
                        border: 1px solid #e5e7eb;
                    }
                    #departmentGroupTierStatistics th:first-child {
                        text-align: left;
                    }
                    #departmentGroupTierStatistics td {
                        padding: 0.75rem;
                        border: 1px solid #e5e7eb;
                        text-align: center;
                    }
                    #departmentGroupTierStatistics td:first-child {
                        text-align: left;
                        font-weight: 500;
                    }
                    #departmentGroupTierStatistics tr:hover {
                        background-color: #f9fafb;
                    }
                    #departmentGroupTierStatistics tr:last-child {
                        background-color: #f3f4f6;
                        font-weight: 600;
                    }
                    .percentage-cell {
                        font-weight: 500;
                    }
                </style>
                <thead>
                    <tr>
                        <th class="border p-2 text-left font-bold" rowspan="2">组别</th>
                        <th class="border p-2 text-center text-green-600" colspan="4">第一梯队</th>
                        <th class="border p-2 text-center text-yellow-600" colspan="4">第二梯队</th>
                        <th class="border p-2 text-center text-red-600" colspan="4">第三梯队</th>
                    </tr>
                    <tr>
                        <th class="border p-2 text-center text-green-600">新人</th>
                        <th class="border p-2 text-center text-blue-600">老人</th>
                        <th class="border p-2 text-center font-bold">总计</th>
                        <th class="border p-2 text-center font-bold">占比</th>
                        <th class="border p-2 text-center text-green-600">新人</th>
                        <th class="border p-2 text-center text-blue-600">老人</th>
                        <th class="border p-2 text-center font-bold">总计</th>
                        <th class="border p-2 text-center font-bold">占比</th>
                        <th class="border p-2 text-center text-green-600">新人</th>
                        <th class="border p-2 text-center text-blue-600">老人</th>
                        <th class="border p-2 text-center font-bold">总计</th>
                        <th class="border p-2 text-center font-bold">占比</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            // 添加每个小组的数据行
            groupArray.forEach(group => {
                // 使用预计算的统计数据
                const stats = groupStats[group] || {};
                const oldTier1 = stats.oldTier1 || 0;
                const oldTier2 = stats.oldTier2 || 0;
                const oldTier3 = stats.oldTier3 || 0;
                const newTier1 = stats.newTier1 || 0;
                const newTier2 = stats.newTier2 || 0;
                const newTier3 = stats.newTier3 || 0;
                
                const oldTotal = oldTier1 + oldTier2 + oldTier3;
                const newTotal = newTier1 + newTier2 + newTier3;
                
                // 合计
                const totalTier1 = oldTier1 + newTier1;
                const totalTier2 = oldTier2 + newTier2;
                const totalTier3 = oldTier3 + newTier3;
                const total = oldTotal + newTotal;
                
                // 计算各梯队占比
                const percentageTier1 = deptTotalTier1 > 0 ? ((totalTier1 / deptTotalTier1) * 100).toFixed(1) : '0.0';
                const percentageTier2 = deptTotalTier2 > 0 ? ((totalTier2 / deptTotalTier2) * 100).toFixed(1) : '0.0';
                const percentageTier3 = deptTotalTier3 > 0 ? ((totalTier3 / deptTotalTier3) * 100).toFixed(1) : '0.0';
                
                tableHTML += `
                    <tr>
                        <td class="border p-2 text-left">${group}</td>
                        <td class="border p-2 text-center text-green-600">${newTier1}</td>
                        <td class="border p-2 text-center text-blue-600">${oldTier1}</td>
                        <td class="border p-2 text-center font-bold">${totalTier1}</td>
                        <td class="border p-2">
                            <div class="percentage-bar" style="width: ${Math.min(parseFloat(percentageTier1) * 5, 100)}%">
                                <div class="percentage-text">${percentageTier1}%</div>
                            </div>
                        </td>
                        <td class="border p-2 text-center text-green-600">${newTier2}</td>
                        <td class="border p-2 text-center text-blue-600">${oldTier2}</td>
                        <td class="border p-2 text-center font-bold">${totalTier2}</td>
                        <td class="border p-2">
                            <div class="percentage-bar" style="width: ${Math.min(parseFloat(percentageTier2) * 5, 100)}%">
                                <div class="percentage-text">${percentageTier2}%</div>
                            </div>
                        </td>
                        <td class="border p-2 text-center text-green-600">${newTier3}</td>
                        <td class="border p-2 text-center text-blue-600">${oldTier3}</td>
                        <td class="border p-2 text-center font-bold">${totalTier3}</td>
                        <td class="border p-2">
                            <div class="percentage-bar" style="width: ${Math.min(parseFloat(percentageTier3) * 5, 100)}%">
                                <div class="percentage-text">${percentageTier3}%</div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            // 添加总计行
            tableHTML += `
                    <tr class="bg-gray-50 font-bold">
                        <td class="border p-2">合计</td>
                        <td class="border p-2 text-center">${deptNewStaff.filter(s => s.tier === 1).length}</td>
                        <td class="border p-2 text-center">${deptOldStaff.filter(s => s.tier === 1).length}</td>
                        <td class="border p-2 text-center">${deptTotalTier1}</td>
                        <td class="border p-2">
                            <div class="percentage-bar" style="width: 100%">
                                <div class="percentage-text">100.0%</div>
                            </div>
                        </td>
                        <td class="border p-2 text-center">${deptNewStaff.filter(s => s.tier === 2).length}</td>
                        <td class="border p-2 text-center">${deptOldStaff.filter(s => s.tier === 2).length}</td>
                        <td class="border p-2 text-center">${deptTotalTier2}</td>
                        <td class="border p-2">
                            <div class="percentage-bar" style="width: 100%">
                                <div class="percentage-text">100.0%</div>
                            </div>
                        </td>
                        <td class="border p-2 text-center">${deptNewStaff.filter(s => s.tier === 3).length}</td>
                        <td class="border p-2 text-center">${deptOldStaff.filter(s => s.tier === 3).length}</td>
                        <td class="border p-2 text-center">${deptTotalTier3}</td>
                        <td class="border p-2">
                            <div class="percentage-bar" style="width: 100%">
                                <div class="percentage-text">100.0%</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
            `;
            
            // 更新统计区域
            const statsContainer = document.getElementById('departmentGroupTierStatistics');
            statsContainer.innerHTML = tableHTML;
            
            // 绑定点击事件到小组统计表格中的数字
            bindTierNumberClickEvents(statsContainer, false);
        }
        
        // 更新总体统计信息
        function updateStatistics() {
            const totalRecords = originalData.length;
            const oldStaffCount = processedOldStaff.length;
            const newStaffCount = processedNewStaff.length;
            const firstTierCount = 
                processedOldStaff.filter(s => s.isFirstTier).length + 
                processedNewStaff.filter(s => s.isFirstTier).length;
            
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('oldStaffCount').textContent = oldStaffCount;
            document.getElementById('newStaffCount').textContent = newStaffCount;
            document.getElementById('firstTierCount').textContent = firstTierCount;
            
            // 更新各员工类型的统计
            updateOldStaffStatistics();
            updateNewStaffStatistics();
            
            // 更新部门梯队统计信息
            updateDepartmentTierStatistics();
        }

        // 打开人员详情模态框
        function openStaffDetailModal(department, tier, staffType, isDepartment, isTotalRow) {
            // 确保模态框存在
            addModalStructure();
            
            // 设置模态框标题
            const tierName = `第${tier}梯队`;
            const title = isTotalRow ? 
                `${tierName}${staffType === '总计' ? '' : staffType}` : 
                `${department} - ${tierName}${staffType === '总计' ? '' : staffType}`;
            document.getElementById('modalTitle').textContent = title;
            
            // 筛选符合条件的人员数据
            let filteredStaff = [];
            
            if (staffType === '新员工') {
                filteredStaff = processedNewStaff.filter(staff => staff.tier === tier);
            } else if (staffType === '老员工') {
                filteredStaff = processedOldStaff.filter(staff => staff.tier === tier);
            } else { // 总计
                filteredStaff = [...processedNewStaff, ...processedOldStaff].filter(staff => staff.tier === tier);
            }
            
            // 如果不是总行，还需要按部门或小组筛选
            if (!isTotalRow) {
                if (isDepartment) {
                    filteredStaff = filteredStaff.filter(staff => staff.五级部门 === department);
                } else {
                    // 这里需要获取当前选择的部门，然后按部门+小组筛选
                    const currentDept = document.getElementById('groupDeptSelector').value;
                    filteredStaff = filteredStaff.filter(staff => 
                        staff.五级部门 === currentDept && staff.小组 === department
                    );
                }
            }
            
            // 显示加载状态
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = '<div class="modal-loading"></div>';
            
            // 显示模态框
            const modal = document.getElementById('staffDetailModal');
            modal.classList.remove('hidden');
            
            // 使用setTimeout确保动画正常触发，并且避免重复调用
            setTimeout(() => {
                // 生成人员数据表格（在generateStaffTable函数中会覆盖加载状态）
                generateStaffTable(filteredStaff, department, tier, staffType);
            }, 50);
        }
        
        // 生成人员数据表格
        function generateStaffTable(staffData, department, tier, staffType) {
            const modalContent = document.getElementById('modalContent');
            
            if (staffData.length === 0) {
                modalContent.innerHTML = '<p class="text-center text-gray-500">暂无数据</p>';
                return;
            }
            
            // 定义需要显示的字段及其显示名称
            const fieldMap = {
                'tier': '梯队',
                '五级部门': '五级部门',
                '小组': '小组',
                '新老员工': '新老员工',
                'ERP账号': 'ERP账号',
                '客服账号': '客服账号',
                '接待量': '接待量',
                '满意度_剔除R': '满意度',
                '解决率_剔除R': '解决率',
                '满意量_剔除R': '满意量',
                '评价量_剔除R': '评价量',
                '已解决量_剔除R': '已解决量',
                '解决率总评价量_剔除R': '解决率总评价量',
                '满意度影响值': '满意度影响值',
                '解决率影响值': '解决率影响值'
            };
            
            // 使用所有指定的字段，不进行过滤，确保所有字段都能显示
            const availableFields = Object.keys(fieldMap);
            
            // 创建表格HTML
            let tableHtml = `
                <div class="overflow-x-auto">
                    <div class="overflow-y-auto max-h-[500px] min-w-[1000px]">
                        <table id="staffDetailTable" class="min-w-full divide-y divide-gray-200 border border-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
            `;
            
            // 添加表头
            availableFields.forEach(field => {
                tableHtml += `<th class="px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider border-r border-gray-200 whitespace-nowrap">${fieldMap[field]}</th>`;
            });
            
            tableHtml += `
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            // 添加数据行，支持分页显示
            const pageSize = 50;
            const totalPages = Math.ceil(staffData.length / pageSize);
            let currentPage = 1;
            
            // 生成当前页的数据
            function renderPage(pageNum) {
                const startIndex = (pageNum - 1) * pageSize;
                const endIndex = startIndex + pageSize;
                const pageData = staffData.slice(startIndex, endIndex);
                
                let rowsHtml = '';
                pageData.forEach((staff, index) => {
                    rowsHtml += '<tr ' + (index % 2 === 0 ? 'class="bg-white"' : 'class="bg-gray-50"') + '>';
                    availableFields.forEach(field => {
                        let value = staff[field] || '';
                        
                        // 格式化特殊字段
                    if (field === 'tier') {
                        value = value ? `第${value}梯队` : '';
                    } else if (field === '满意度_剔除R' || field === '解决率_剔除R') {
                        value = typeof value === 'number' ? (value * 100).toFixed(1) + '%' : value;
                    } else if (['满意度影响值', '解决率影响值'].includes(field)) {
                        // 影响值保留六位小数
                        value = typeof value === 'number' ? value.toFixed(6) : value;
                    } else if (typeof value === 'number') {
                        // 其他数值字段保留一位小数
                        value = value.toFixed(1);
                    }
                        
                        rowsHtml += `<td class="px-3 py-2 whitespace-nowrap text-sm text-gray-800 border-r border-gray-200">${value}</td>`;
                    });
                    rowsHtml += '</tr>';
                });
                
                // 更新表格内容
                const tbody = modalContent.querySelector('tbody');
                if (tbody) {
                    tbody.innerHTML = rowsHtml;
                }
                
                // 更新分页信息
                updatePaginationInfo(pageNum, totalPages, staffData.length);
            }
            
            // 更新分页信息
            function updatePaginationInfo(pageNum, totalPages, totalItems) {
                let paginationHtml = '';
                if (totalPages > 1) {
                    paginationHtml = `
                        <div class="mt-4 flex justify-between items-center">
                            <div class="text-sm text-gray-500">
                                显示 ${(pageNum - 1) * pageSize + 1} 到 ${Math.min(pageNum * pageSize, totalItems)} 条，共 ${totalItems} 条
                            </div>
                            <div class="flex space-x-1">
                                <button onclick="renderPage(${Math.max(1, pageNum - 1)})" ${pageNum === 1 ? 'disabled' : ''} 
                                        class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50">
                                    上一页
                                </button>
                                <span class="px-3 py-1">${pageNum} / ${totalPages}</span>
                                <button onclick="renderPage(${Math.min(totalPages, pageNum + 1)})" ${pageNum === totalPages ? 'disabled' : ''} 
                                        class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50">
                                    下一页
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                const paginationContainer = modalContent.querySelector('.pagination-container');
                if (paginationContainer) {
                    paginationContainer.innerHTML = paginationHtml;
                }
            }
            
            tableHtml += `
                    </tbody>
                </table>
                    </div>
                </div>
                <div class="pagination-container"></div>`;
            
            modalContent.innerHTML = tableHtml;
            
            // 渲染第一页
            renderPage(currentPage);
            
            // 将渲染函数绑定到window对象，以便分页按钮可以调用
            window.renderPage = renderPage;
            
            // 为下载按钮绑定事件
            document.getElementById('downloadTableBtn').onclick = function() {
                downloadStaffTable(staffData, department, tier, staffType, availableFields, fieldMap);
            };
        }
        
        // 下载人员数据表格为CSV
        function downloadStaffTable(staffData, department, tier, staffType, availableFields, fieldMap) {
            if (!staffData || staffData.length === 0) {
                alert('没有数据可下载');
                return;
            }
            
            // 准备CSV内容
            let csvContent = '';
            
            // 添加表头
            const headers = availableFields.map(field => fieldMap[field]);
            csvContent += headers.join(',') + '\n';
            
            // 添加数据行
            staffData.forEach(staff => {
                const row = availableFields.map(field => {
                    let value = staff[field] || '';
                    
                    // 格式化特殊字段
                        if (field === 'tier') {
                            value = value ? `第${value}梯队` : '';
                        } else if (field === '满意度_剔除R' || field === '解决率_剔除R') {
                            value = typeof value === 'number' ? (value * 100).toFixed(1) + '%' : value;
                        } else if (['满意度影响值', '解决率影响值'].includes(field)) {
                            // 影响值保留六位小数
                            value = typeof value === 'number' ? value.toFixed(6) : value;
                        } else if (typeof value === 'number') {
                            // 其他数值字段保留一位小数
                            value = value.toFixed(1);
                        }
                    
                    // 如果值包含逗号、双引号或换行符，需要用双引号包围并转义
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    
                    return value;
                });
                csvContent += row.join(',') + '\n';
            });
            
            // 生成文件名
            const tierName = `第${tier}梯队`;
            const fileName = isTotalRow => {
                const baseName = isTotalRow ? 
                    `${tierName}${staffType === '总计' ? '' : staffType}` : 
                    `${department} - ${tierName}${staffType === '总计' ? '' : staffType}`;
                return `${baseName}_人员数据_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.csv`;
            };
            
            // 创建Blob并下载
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) { // 支持HTML5下载
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName(department === '总计' || department === '合计'));
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // 降级方案，使用navigator.msSaveBlob（IE10+）
                if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(blob, fileName(department === '总计' || department === '合计'));
                } else {
                    alert('当前浏览器不支持文件下载');
                }
            }
        }
        
        // 切换跳转方向
        function toggleJump() {
            jumpToNewStaff = !jumpToNewStaff;
            
            if (jumpToNewStaff) {
                jumpBtn.innerHTML = '<i class="fa fa-exchange mr-2"></i><span>跳转至新员工数据</span>';
                newStaffSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                jumpBtn.innerHTML = '<i class="fa fa-exchange mr-2"></i><span>跳转至老员工数据</span>';
                oldStaffSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // 导出结果
        function exportResults(type) {
            const data = type === 'old' ? oldStaffFiltered : newStaffFiltered;
            if (data.length === 0) {
                alert(`没有可导出的${type === 'old' ? '老员工' : '新员工'}数据`);
                return;
            }
            
            // 准备导出数据（按页面展示格式，梯队在前，非第一梯队原因在后）
            const exportData = data.map(staff => {
                // 先构建基础字段对象
                const baseFields = {...staff};
                delete baseFields.isFirstTier;
                delete baseFields.isSecondTier;
                delete baseFields.isThirdTier;
                delete baseFields.未达标项;
                delete baseFields.差距值;
                
                // 格式化数值为页面展示格式
                const formattedFields = {};
                for (const key in baseFields) {
                    let value = baseFields[key];
                    
                    if (typeof value === 'number') {
                        // 满意度影响值和解决率影响值特殊处理：显示为数字格式，保留6位小数
                if (key === '满意度影响值' || key === '解决率影响值') {
                    formattedFields[key] = value.toFixed(6);
                }
                        // 解决率总评价量_剔除R保持数字格式
                        else if (key === '解决率总评价量_剔除R') {
                            formattedFields[key] = value.toFixed(0);
                        }
                        // 差异量字段保持整数格式
                        else if (key === '满意度差异量' || key === '解决率差异量') {
                            formattedFields[key] = value.toFixed(0);
                        }
                        // 百分比字段（排除解决率总评价量_剔除R和差异量字段）
                        else if ((key.includes('满意度') || key.includes('解决率')) && !key.includes('差异量')) {
                            formattedFields[key] = (value * 100).toFixed(1) + '%';
                        }
                        // 分值字段
                        else if (key.includes('Score') || key.includes('分值')) {
                            formattedFields[key] = value.toFixed(0);
                        }
                        // 其他数字保留两位小数
                        else {
                            formattedFields[key] = value.toFixed(2);
                        }
                    } else {
                        formattedFields[key] = value || '';
                    }
                }
                
                // 添加梯队显示文本
                let tierText = '';
                if (staff.tier === 1) tierText = '第一梯队';
                else if (staff.tier === 2) tierText = '第二梯队';
                else if (staff.tier === 3) tierText = '第三梯队';
                
                // 构建最终导出对象，确保梯队在前，非第一梯队原因在后，同时保留所有字段包括小组
                const orderedFields = {
                    '梯队': tierText,
                    ...Object.fromEntries(
                        Object.entries(formattedFields).filter(([k]) => k !== '非第一梯队原因' && k !== 'tier')
                    ),
                    '非第一梯队原因': formattedFields['非第一梯队原因'] || ''
                };
                
                return orderedFields;
            });
            
            // 创建工作簿和工作表
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, type === 'old' ? '老员工数据' : '新员工数据');
            
            // 导出文件
            XLSX.writeFile(workbook, `${type === 'old' ? '老员工' : '新员工'}数据_${new Date().toLocaleDateString()}.xlsx`);
        }

        // 导出为图片
        function exportAsImage(type) {
            // 使用筛选后的数据，确保导出跟随筛选条件
            const filteredData = type === 'old' ? oldStaffFiltered : newStaffFiltered;
            
            if (filteredData.length === 0) {
                alert(`没有可导出的${type === 'old' ? '老员工' : '新员工'}数据`);
                return;
            }
            
            const container = type === 'old' ? oldStaffSection : newStaffSection;
            const resultSection = container.querySelector('.p-6:last-child'); // 处理结果部分
            
            if (!resultSection) {
                alert(`没有可导出的${type === 'old' ? '老员工' : '新员工'}处理结果`);
                return;
            }
            
            // 创建一个新的容器，只包含处理结果部分
            const exportContainer = document.createElement('div');
            exportContainer.className = 'bg-white rounded-xl shadow-lg overflow-hidden';
            
            // 添加标题
            const titleDiv = document.createElement('div');
            titleDiv.className = 'p-4 border-b border-gray-100';
            titleDiv.innerHTML = `<h3 class="font-medium">${type === 'old' ? '老员工' : '新员工'}处理结果</h3>`;
            exportContainer.appendChild(titleDiv);
            
            // 克隆处理结果部分
            const resultClone = resultSection.cloneNode(true);
            
            // 移除分页控件
            const paginationElements = resultClone.querySelectorAll('#oldPagination, #oldPageNumbers, #newPagination, #newPageNumbers, #oldPrevPage, #oldNextPage, #newPrevPage, #newNextPage, #oldPageNumbersBottom, #newPageNumbersBottom, #oldPrevPageBottom, #oldNextPageBottom');
            paginationElements.forEach(el => el.remove());
            
            // 移除底部的分页文字信息
            const paginationTexts = resultClone.querySelectorAll('.text-sm.text-gray-500');
            paginationTexts.forEach(el => el.remove());
            
            // 移除底部的分页容器
            const paginationContainers = resultClone.querySelectorAll('.mt-4.flex, .mb-4.flex');
            paginationContainers.forEach(el => {
                // 检查是否包含分页按钮或页码
                const hasPagination = el.querySelector('.pagination-btn, #oldPageNumbers, #newPageNumbers') !== null;
                if (hasPagination) {
                    el.remove();
                }
            });
            
            exportContainer.appendChild(resultClone);
            
            // 清空并添加到临时容器
            imageExportContainer.innerHTML = '';
            imageExportContainer.appendChild(exportContainer);
            
            // 保存当前样式，然后为截图设置合适的样式
            const originalStyles = imageExportContainer.className;
            
            // 设置适合截图的样式 - 确保内容可见且能被正确渲染
            imageExportContainer.className = 'position: static; opacity: 1; z-index: 1; width: auto; height: auto; background-color: white;';
            
            // 强制可见性，确保内容完全加载
            imageExportContainer.style.visibility = 'visible';
            imageExportContainer.style.position = 'static';
            imageExportContainer.style.opacity = '1';
            imageExportContainer.style.zIndex = '1';
            imageExportContainer.style.width = 'auto';
            imageExportContainer.style.height = 'auto';
            imageExportContainer.style.backgroundColor = 'white';
            imageExportContainer.style.margin = '0';
            imageExportContainer.style.padding = '0';
            imageExportContainer.style.border = 'none';
            
            // 延迟截图以确保DOM已更新
            setTimeout(() => {
                // 直接对导出容器进行截图，而不是整个imageExportContainer
                html2canvas(exportContainer, {
                    scale: 2, // 提高分辨率
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff', // 使用白色背景而不是透明
                    allowTaint: true,
                    useTransform: true,
                    removeContainer: false
                }).then(canvas => {
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.download = `${type === 'old' ? '老员工' : '新员工'}筛选结果表格_${new Date().toLocaleDateString()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // 恢复原始样式
                    imageExportContainer.className = originalStyles;
                    imageExportContainer.style = '';
                }).catch(error => {
                    console.error('导出图片失败:', error);
                    alert('导出图片失败: ' + error.message);
                    // 确保恢复原始样式
                    imageExportContainer.className = originalStyles;
                    imageExportContainer.style = '';
                });
            }, 300);
        }

        // 移除文件
        function removeFile() {
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            resultsSection.classList.add('hidden');
            floatingJumpBtn.classList.add('hidden');
            originalData = [];
            processedOldStaff = [];
            processedNewStaff = [];
            originalHeaders = [];
            oldStaffFiltered = [];
            newStaffFiltered = [];
        }

        // 下载模板
        function downloadTemplate() {
            // 创建模板数据，包含"新老员工"字段
            const templateData = [
                {
                    'ERP账号': '10001',
                    '姓名': '张三',
                    '五级部门': '客服一部',
                    '新老员工': '老员工',
                    '满意度_剔除R': 0.85,
                    '解决率_剔除R': 0.75,
                    '评价量_剔除R': 10,
                    '解决率总评价量_剔除R': 10,
                    '已解决量_剔除R': 8
                },
                {
                    'ERP账号': '10002',
                    '姓名': '李四',
                    '五级部门': '客服二部',
                    '新老员工': '新员工',
                    '满意度_剔除R': 0.82,
                    '解决率_剔除R': 0.68,
                    '评价量_剔除R': 7,
                    '解决率总评价量_剔除R': 7,
                    '已解决量_剔除R': 6
                }
            ];
            
            // 创建工作簿和工作表
            const worksheet = XLSX.utils.json_to_sheet(templateData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '数据模板');
            
            // 导出文件
            XLSX.writeFile(workbook, `客服数据模板.xlsx`);
        }

        // 初始化
        console.log('页面加载中...');
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM内容加载完成，准备初始化事件监听器');
            try {
                initEventListeners();
                console.log('事件监听器初始化完成');
            } catch (error) {
                console.error('初始化事件监听器时出错:', error);
            }
        });
    </script>
</body>
</html>
